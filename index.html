<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Chaos Arena: Survive</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; }
        /* МЕНЮ */
        #menu {
            position: fixed; inset: 0; background: rgba(0,0,0,0.9);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 100; color: white;
        }
        .btn {
            padding: 15px 40px; font-size: 24px; cursor: pointer;
            background: #ff4400; color: white; border: none; border-radius: 5px; margin: 10px;
        }
        /* ИНТЕРФЕЙС */
        #ui { position: fixed; top: 10px; left: 10px; color: #fff; display: none; z-index: 10; pointer-events: none; }
        #fps { position: fixed; top: 10px; right: 10px; color: #0f0; font-family: monospace; }
        #hp-bar { width: 200px; height: 20px; background: #400; border: 2px solid #fff; }
        #hp-fill { width: 100%; height: 100%; background: #0f0; transition: 0.1s; }
        #zone-warn { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                     color: red; font-size: 40px; display: none; font-weight: bold; }
    </style>
</head>
<body>

    <div id="menu">
        <h1>CHAOS ARENA</h1>
        <button class="btn" onclick="startGame()">В БОЙ</button>
        <div style="margin-top:20px;">WASD - Ходить | Space - Бить</div>
    </div>

    <div id="fps">FPS: 0</div>
    <div id="ui">
        <div>HEALTH</div>
        <div id="hp-bar"><div id="hp-fill"></div></div>
        <div id="stats">Kills: 0</div>
    </div>
    <div id="zone-warn">ВНЕ ЗОНЫ!</div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        let gameActive = false;
        let hp = 100;
        let kills = 0;
        let zoneRadius = 150;
        const enemies = [];
        const medkits = [];
        const keys = {};

        // FPS счетчик
        let lastTime = performance.now();
        let frames = 0;

        function startGame() {
            document.getElementById('menu').style.display = 'none';
            document.getElementById('ui').style.display = 'block';
            gameActive = true;
            init();
        }

        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });

        function init() {
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            const light = new THREE.DirectionalLight(0xffffff, 1);
            light.position.set(10, 50, 10);
            scene.add(light);
            scene.add(new THREE.AmbientLight(0x404040));

            // Земля
            const floor = new THREE.Mesh(new THREE.PlaneGeometry(400, 400), new THREE.MeshStandardMaterial({ color: 0x222222 }));
            floor.rotation.x = -Math.PI / 2;
            scene.add(floor);

            // Визуализация зоны
            const zoneGeo = new THREE.RingGeometry(145, 150, 64);
            const zoneMat = new THREE.MeshBasicMaterial({ color: 0xff0000, side: THREE.DoubleSide });
            const zoneVisual = new THREE.Mesh(zoneGeo, zoneMat);
            zoneVisual.rotation.x = -Math.PI / 2;
            zoneVisual.position.y = 0.2;
            zoneVisual.name = "zoneBorder";
            scene.add(zoneVisual);

            spawnPlayer();
            animate();
        }

        let player;
        function spawnPlayer() {
            player = new THREE.Group();
            const body = new THREE.Mesh(new THREE.CapsuleGeometry(0.8, 1.5), new THREE.MeshStandardMaterial({ color: 0x0088ff }));
            body.position.y = 1.25;
            const eye = new THREE.Mesh(new THREE.BoxGeometry(0.8, 0.2, 0.4), new THREE.MeshStandardMaterial({ color: 0xffffff }));
            eye.position.set(0, 1.8, 0.5);
            player.add(body, eye);
            scene.add(player);
        }

        function createEnemy() {
            const enemy = new THREE.Group();
            const body = new THREE.Mesh(new THREE.CapsuleGeometry(0.8, 1.5), new THREE.MeshStandardMaterial({ color: 0xff0044 }));
            body.position.y = 1.25;
            enemy.add(body);
            // Случайный спавн внутри зоны
            const ang = Math.random() * Math.PI * 2;
            const dist = Math.random() * (zoneRadius - 10);
            enemy.position.set(Math.cos(ang) * dist, 0, Math.sin(ang) * dist);
            scene.add(enemy);
            enemies.push({ mesh: enemy, hp: 50 });
        }

        function spawnMedkit() {
            const kit = new THREE.Mesh(new THREE.BoxGeometry(1.5, 0.5, 1.5), new THREE.MeshStandardMaterial({ color: 0x00ff88 }));
            kit.position.set((Math.random()-0.5)*100, 0.25, (Math.random()-0.5)*100);
            scene.add(kit);
            medkits.push(kit);
        }

        window.addEventListener('keydown', e => keys[e.code] = true);
        window.addEventListener('keyup', e => keys[e.code] = false);

        function animate() {
            if (!gameActive) return;
            requestAnimationFrame(animate);

            // FPS
            frames++;
            const now = performance.now();
            if (now > lastTime + 1000) {
                document.getElementById('fps').innerText = "FPS: " + frames;
                frames = 0;
                lastTime = now;
                // Постоянный хаос: спавн врагов и аптечек
                if (enemies.length < 10) createEnemy();
                if (medkits.length < 3) spawnMedkit();
            }

            // Управление
            let mx = 0, mz = 0;
            if (keys['KeyW']) mz -= 1; if (keys['KeyS']) mz += 1;
            if (keys['KeyA']) mx -= 1; if (keys['KeyD']) mx += 1;
            if (mx !== 0 || mz !== 0) {
                player.position.x += mx * 0.5;
                player.position.z += mz * 0.5;
                player.rotation.y = Math.atan2(mx, mz);
            }

            // Атака
            if (keys['Space']) {
                enemies.forEach((en, i) => {
                    if (player.position.distanceTo(en.mesh.position) < 5) {
                        en.hp -= 5;
                        if (en.hp <= 0) {
                            scene.remove(en.mesh);
                            enemies.splice(i, 1);
                            kills++;
                            document.getElementById('stats').innerText = "Kills: " + kills;
                        }
                    }
                });
            }

            // Зона
            zoneRadius -= 0.02;
            const zoneBorder = scene.getObjectByName("zoneBorder");
            if (zoneBorder) {
                zoneBorder.scale.set(zoneRadius/150, zoneRadius/150, 1);
            }

            const pDist = Math.sqrt(player.position.x**2 + player.position.z**2);
            if (pDist > zoneRadius) {
                hp -= 0.3;
                document.getElementById('zone-warn').style.display = 'block';
            } else {
                document.getElementById('zone-warn').style.display = 'none';
            }

            // Аптечки
            medkits.forEach((kit, i) => {
                if (player.position.distanceTo(kit.position) < 3) {
                    hp = Math.min(100, hp + 20);
                    scene.remove(kit);
                    medkits.splice(i, 1);
                }
            });

            // ИИ врагов
            enemies.forEach(en => {
                const d = en.mesh.position.distanceTo(player.position);
                if (d < 50 && d > 2) {
                    en.mesh.lookAt(player.position);
                    en.mesh.translateZ(0.2);
                }
                if (d <= 2.5) hp -= 0.2;
            });

            // Обновление HP
            document.getElementById('hp-fill').style.width = hp + "%";
            if (hp <= 0) {
                gameActive = false;
                alert("ВЫ ПОГИБЛИ! КИЛЛОВ: " + kills);
                location.reload();
            }

            camera.position.set(player.position.x, 50, player.position.z + 35);
            camera.lookAt(player.position);
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
