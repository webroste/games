<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Mobile Minecraft Clone</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <style>
        body { margin: 0; overflow: hidden; background: #87CEEB; touch-action: none; font-family: sans-serif; }
        canvas { display: block; }

        /* –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –ø–æ–≤–æ—Ä–æ—Ç–∞ —ç–∫—Ä–∞–Ω–∞ */
        #rotate-overlay {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #1a1a1a; color: white; z-index: 9999;
            flex-direction: column; justify-content: center; align-items: center;
        }
        @media (orientation: portrait) { #rotate-overlay { display: flex; } }

        /* –ü—Ä–∏—Ü–µ–ª */
        #crosshair {
            position: absolute; top: 50%; left: 50%; width: 20px; height: 20px;
            color: white; transform: translate(-50%, -50%); font: 24px Arial;
            pointer-events: none; opacity: 0.8;
        }

        /* –î–∂–æ–π—Å—Ç–∏–∫ */
        #joystick-wrapper {
            position: absolute; bottom: 40px; left: 40px; width: 120px; height: 120px;
            background: rgba(255, 255, 255, 0.1); border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%; touch-action: none;
        }
        #joystick-stick {
            position: absolute; top: 50%; left: 50%; width: 50px; height: 50px;
            background: rgba(255, 255, 255, 0.4); border-radius: 50%;
            transform: translate(-50%, -50%); pointer-events: none;
        }
    </style>
</head>
<body>

    <div id="rotate-overlay">
        <div style="font-size: 40px; margin-bottom: 10px;">üîÑ</div>
        <div>–ü–æ–≤–µ—Ä–Ω–∏ —Ç–µ–ª–µ—Ñ–æ–Ω –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ</div>
    </div>

    <div id="crosshair">+</div>

    <div id="joystick-wrapper">
        <div id="joystick-stick"></div>
    </div>

    <script type="module">
        import * as THREE from 'https://cdn.skypack.dev/three@0.136.0';

        // --- 1. –ù–ê–°–¢–†–û–ô–ö–ê –ú–ò–†–ê ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87CEEB);
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        document.body.appendChild(renderer.domElement);

        const light = new THREE.AmbientLight(0xffffff, 0.7);
        scene.add(light);
        const sun = new THREE.DirectionalLight(0xffffff, 0.8);
        sun.position.set(10, 20, 10);
        scene.add(sun);

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–ª–∞
        const boxGeo = new THREE.BoxGeometry(1, 1, 1);
        const grassMat = new THREE.MeshStandardMaterial({ color: 0x4caf50 });
        for(let x = -15; x < 15; x++) {
            for(let z = -15; z < 15; z++) {
                const block = new THREE.Mesh(boxGeo, grassMat);
                block.position.set(x, 0, z);
                scene.add(block);
            }
        }
        camera.position.y = 2;

        // --- 2. –£–ü–†–ê–í–õ–ï–ù–ò–ï (–î–ñ–û–ô–°–¢–ò–ö) ---
        const stick = document.getElementById('joystick-stick');
        const wrapper = document.getElementById('joystick-wrapper');
        let moveX = 0, moveZ = 0, isMoving = false;

        wrapper.addEventListener('touchstart', (e) => { 
            isMoving = true; 
            if (document.documentElement.requestFullscreen) document.documentElement.requestFullscreen().catch(() => {});
        });

        document.addEventListener('touchmove', (e) => {
            if (!isMoving) return;
            const touch = Array.from(e.touches).find(t => t.target === wrapper || wrapper.contains(t.target));
            if (!touch) return;

            const rect = wrapper.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            
            let dx = touch.clientX - centerX;
            let dy = touch.clientY - centerY;
            const dist = Math.min(Math.sqrt(dx*dx + dy*dy), 50);
            const angle = Math.atan2(dy, dx);

            stick.style.transform = `translate(calc(-50% + ${Math.cos(angle)*dist}px), calc(-50% + ${Math.sin(angle)*dist}px))`;
            
            moveX = (Math.cos(angle) * dist) / 50;
            moveZ = (Math.sin(angle) * dist) / 50;
        });

        document.addEventListener('touchend', () => {
            isMoving = false;
            stick.style.transform = 'translate(-50%, -50%)';
            moveX = 0; moveZ = 0;
        });

        // --- 3. –í–†–ê–©–ï–ù–ò–ï –ö–ê–ú–ï–†–´ ---
        let lon = 0, lat = 0;
        let startX, startY;
        
        document.addEventListener('touchstart', (e) => {
            if (e.target.id === 'joystick-wrapper') return;
            startX = e.touches[0].clientX;
            startY = e.touches[0].clientY;
        });

        document.addEventListener('touchmove', (e) => {
            const touch = e.touches[e.touches.length - 1];
            if (touch.clientX < 200 && touch.clientY > window.innerHeight - 200) return; // –ò–≥–Ω–æ—Ä–∏–º –∑–æ–Ω—É –¥–∂–æ–π—Å—Ç–∏–∫–∞

            const dx = touch.clientX - startX;
            const dy = touch.clientY - startY;
            startX = touch.clientX;
            startY = touch.clientY;

            lon -= dx * 0.2;
            lat = Math.max(-85, Math.min(85, lat + dy * 0.2));
        });

        // --- 4. –¶–ò–ö–õ –ò–ì–†–´ ---
        function animate() {
            requestAnimationFrame(animate);

            if (moveX !== 0 || moveZ !== 0) {
                const speed = 0.12;
                const yaw = camera.rotation.y;
                // –î–≤–∏–∂–µ–Ω–∏–µ –≤–ø–µ—Ä–µ–¥/–Ω–∞–∑–∞–¥ –∏ –≤–ª–µ–≤–æ/–≤–ø—Ä–∞–≤–æ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –≤–∑–≥–ª—è–¥–∞
                camera.position.x += (Math.cos(yaw) * moveX + Math.sin(yaw) * moveZ) * speed;
                camera.position.z += (Math.sin(yaw) * -moveX + Math.cos(yaw) * moveZ) * speed;
            }

            camera.rotation.order = "YXZ";
            camera.rotation.y = lon * Math.PI / 180;
            camera.rotation.x = lat * Math.PI / 180;

            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        animate();
    </script>
</body>
</html>
