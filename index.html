<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Chaos Arena: DEBUG MODE</title>
    <style>
        body { margin: 0; overflow: hidden; background: #333; color: white; font-family: monospace; }
        
        /* КОНСОЛЬ ОТЛАДКИ (Видна всегда) */
        #debug-console {
            position: fixed; top: 0; left: 0; width: 100%; height: 150px;
            background: rgba(0,0,0,0.8); color: #0f0; padding: 10px;
            pointer-events: none; z-index: 9999; overflow-y: auto;
            border-bottom: 2px solid white; font-size: 14px;
        }

        /* ИНТЕРФЕЙС ИГРЫ */
        #ui { position: fixed; bottom: 10px; left: 10px; pointer-events: none; display: none; }
        #hp-bar { width: 200px; height: 20px; background: #500; border: 2px solid #fff; }
        #hp-fill { width: 100%; height: 100%; background: #0f0; }
        
        #btn-start {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            padding: 20px 40px; font-size: 24px; cursor: pointer; background: #fff; color: #000;
            border: none; border-radius: 5px; z-index: 100;
        }
    </style>
</head>
<body>

    <div id="debug-console">Инициализация страницы...<br></div>
    <button id="btn-start">ЗАПУСТИТЬ ТЕСТ</button>

    <div id="ui">
        <div>HP HERO</div>
        <div id="hp-bar"><div id="hp-fill"></div></div>
        <div id="info">Управление: WASD + Space | Q - Dash | E - Boom</div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js" onerror="logError('ОШИБКА: Не удалось загрузить Three.js! Проверь интернет.')"></script>
    
    <script>
        // === СИСТЕМА ЛОГОВ ===
        function log(msg) {
            const el = document.getElementById('debug-console');
            el.innerHTML += "> " + msg + "<br>";
            el.scrollTop = el.scrollHeight;
            console.log(msg);
        }

        function logError(msg) {
            const el = document.getElementById('debug-console');
            el.style.color = 'red';
            el.innerHTML += "!!! КРИТИЧЕСКАЯ ОШИБКА: " + msg + "<br>";
        }

        window.onerror = function(message, source, lineno, colno, error) {
            logError(message + " (Line: " + lineno + ")");
        };

        // Переменные
        let scene, camera, renderer, player;
        let isRunning = false;
        let hp = 100;
        let zoneRadius = 150;
        const enemies = [];
        const keys = {};

        // === КНОПКА ЗАПУСКА ===
        document.getElementById('btn-start').addEventListener('click', () => {
            document.getElementById('btn-start').style.display = 'none';
            try {
                startEngine();
            } catch (e) {
                logError(e);
            }
        });

        function startEngine() {
            log("Запуск движка...");
            
            if (typeof THREE === 'undefined') {
                throw new Error("Библиотека THREE не найдена. Скрипт не загрузился.");
            }

            // 1. Сцена
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x000033); // ТЕМНО-СИНИЙ ФОН
            log("Сцена создана. Фон установлен (Синий).");

            // 2. Камера
            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 50, 50);
            camera.lookAt(0, 0, 0);

            // 3. Рендерер (Без наворотов)
            renderer = new THREE.WebGLRenderer({ antialias: false });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);
            log("WebGL Renderer создан.");

            // 4. Свет
            const light = new THREE.DirectionalLight(0xffffff, 1);
            light.position.set(0, 50, 0);
            scene.add(light);
            scene.add(new THREE.AmbientLight(0xffffff, 0.5));

            // 5. Пол
            const grid = new THREE.GridHelper(300, 30);
            scene.add(grid);
            const floor = new THREE.Mesh(
                new THREE.PlaneGeometry(300, 300), 
                new THREE.MeshBasicMaterial({ color: 0x222222, side: THREE.DoubleSide })
            );
            floor.rotation.x = -Math.PI / 2;
            scene.add(floor);
            log("Геометрия мира создана.");

            // 6. Игрок
            player = new THREE.Group();
            const body = new THREE.Mesh(new THREE.BoxGeometry(2, 4, 2), new THREE.MeshBasicMaterial({ color: 0x00ffff }));
            body.position.y = 2;
            player.add(body);
            scene.add(player);

            // 7. Зона (Красная стена)
            const zoneGeo = new THREE.CylinderGeometry(zoneRadius, zoneRadius, 20, 32, 1, true);
            const zoneMat = new THREE.MeshBasicMaterial({ color: 0xff0000, transparent: true, opacity: 0.3, side: THREE.DoubleSide });
            const zone = new THREE.Mesh(zoneGeo, zoneMat);
            zone.name = "ZoneWall";
            zone.position.y = 10;
            scene.add(zone);

            // 8. Управление
            window.addEventListener('keydown', e => keys[e.code] = true);
            window.addEventListener('keyup', e => keys[e.code] = false);

            document.getElementById('ui').style.display = 'block';
            isRunning = true;
            log("Цикл рендера запущен!");
            animate();
        }

        // Спавн врагов
        function spawnEnemy() {
            const en = new THREE.Mesh(new THREE.BoxGeometry(2, 2, 2), new THREE.MeshBasicMaterial({ color: 0xff0000 }));
            const angle = Math.random() * Math.PI * 2;
            const dist = zoneRadius - 10;
            en.position.set(Math.cos(angle)*dist, 1, Math.sin(angle)*dist);
            scene.add(en);
            
            // HP Bar
            const hpGeo = new THREE.PlaneGeometry(3, 0.5);
            const hpMat = new THREE.MeshBasicMaterial({ color: 0x00ff00 });
            const hpMesh = new THREE.Mesh(hpGeo, hpMat);
            hpMesh.position.y = 3;
            en.add(hpMesh);

            enemies.push({ mesh: en, hp: 50, hpBar: hpMesh });
        }

        function animate() {
            if (!isRunning) return;
            requestAnimationFrame(animate);

            // --- ЛОГИКА ---
            // Спавн
            if (Math.random() < 0.02 && enemies.length < 15) spawnEnemy();

            // Движение игрока
            let dx = 0, dz = 0;
            if (keys['KeyW']) dz -= 1; if (keys['KeyS']) dz += 1;
            if (keys['KeyA']) dx -= 1; if (keys['KeyD']) dx += 1;
            player.position.x += dx * 0.5;
            player.position.z += dz * 0.5;
            
            // Навыки
            // Q - Dash
            if (keys['KeyQ']) {
                player.position.x += dx * 5;
                player.position.z += dz * 5;
            }
            // E - Explosion
            if (keys['KeyE']) {
                enemies.forEach((en, i) => {
                    if (player.position.distanceTo(en.mesh.position) < 15) {
                        scene.remove(en.mesh);
                        enemies.splice(i, 1);
                    }
                });
            }

            // Атака (Space)
            if (keys['Space']) {
                enemies.forEach((en, i) => {
                    if (player.position.distanceTo(en.mesh.position) < 5) {
                        en.hp -= 5;
                        en.hpBar.scale.x = en.hp / 50;
                        if (en.hp <= 0) {
                            scene.remove(en.mesh);
                            enemies.splice(i, 1);
                        }
                    }
                });
            }

            // Враги
            enemies.forEach(en => {
                en.mesh.lookAt(player.position);
                en.mesh.translateZ(0.2);
                en.hpBar.lookAt(camera.position);
                if (en.mesh.position.distanceTo(player.position) < 2) hp -= 0.1;
            });

            // Зона
            zoneRadius -= 0.05;
            const zoneMesh = scene.getObjectByName("ZoneWall");
            if(zoneMesh) {
                const s = zoneRadius / 150;
                zoneMesh.scale.set(s, 1, s);
            }
            if (player.position.length() > zoneRadius) hp -= 0.5;

            // UI
            document.getElementById('hp-fill').style.width = Math.max(0, hp) + "%";
            if (hp <= 0) {
                isRunning = false;
                alert("Game Over");
                location.reload();
            }

            // Камера
            camera.position.x = player.position.x;
            camera.position.z = player.position.z + 40;
            camera.lookAt(player.position);

            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
