<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Chaos Arena v22: Total War</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Courier New', monospace; color: #00ffff; user-select: none; }
        #ui { position: fixed; inset: 0; pointer-events: none; z-index: 10; display: none; }
        
        #menu { 
            position: fixed; inset: 0; 
            background: radial-gradient(circle at 20% 50%, #001020 0%, #000 100%); 
            display: flex; flex-direction: column; align-items: flex-start; justify-content: center; 
            z-index: 1000; padding-left: 5%; border-left: 10px solid #00ffff; 
        }
        .menu-title { font-size: 50px; text-shadow: 0 0 20px #00ffff; margin-bottom: 20px; }
        .btn { 
            background: rgba(0, 0, 0, 0.7); color: #00ffff; border: 2px solid #00ffff; 
            padding: 15px 30px; font-size: 18px; cursor: pointer; margin: 10px 0; 
            transition: 0.3s; width: 320px; text-align: left; font-weight: bold; text-transform: uppercase; 
        }
        .btn:hover { background: #00ffff; color: #000; box-shadow: 0 0 25px #00ffff; transform: translateX(10px); }

        #hp-bar { width: 300px; height: 15px; background: #200; border: 2px solid #00ffff; position: absolute; bottom: 40px; left: 40px; }
        #hp-fill { width: 100%; height: 100%; background: #00ffff; transition: 0.2s; }
        #ability-ui { position: absolute; bottom: 65px; left: 40px; font-size: 14px; font-weight: bold; text-shadow: 0 0 5px #00ffff; }
        #weapon-info { position: absolute; bottom: 40px; right: 40px; font-size: 24px; text-align: right; color: #ffff00; }
        
        #minimap { position: absolute; top: 20px; left: 20px; width: 180px; height: 180px; background: rgba(0,0,0,0.8); border: 2px solid #00ffff; border-radius: 50%; overflow: hidden; }
        #map-canvas { width: 100%; height: 100%; }

        .nickname { position: absolute; font-weight: bold; font-size: 11px; text-shadow: 2px 2px 2px black; pointer-events: none; text-align: center; }
        #version-tag { position: fixed; bottom: 10px; right: 15px; font-size: 12px; color: rgba(0, 255, 255, 0.5); z-index: 1001; }
    </style>
</head>
<body>

<div id="version-tag">BUILD: v0.22.total_war</div>
<div id="menu">
    <div class="menu-title">CHAOS ARENA</div>
    <div class="btn" onclick="startGame()">НАЧАТЬ МИССИЮ</div>
</div>

<div id="ui">
    <div id="minimap"><canvas id="map-canvas"></canvas></div>
    <div id="hp-bar"><div id="hp-fill"></div></div>
    <div id="ability-ui">SHIFT: PHANTOM <span id="ability-status">READY</span></div>
    <div id="weapon-info">ОРУЖИЕ: <span id="current-weapon">PISTOL</span></div>
    <div id="stats" style="position: absolute; top: 20px; right: 30px; font-size: 20px;">KILLS: <span id="kills">0</span></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
let scene, camera, renderer, player, clock, mapCtx;
let gameActive = false, entities = [], bullets = [], buildings = [], medkits = [], lootBoxes = [];
let keys = {}, score = 0, zoneMesh, zoneRadius = 250, startTime, abilityCD = 0;

const ALLY_COLOR = 0x0066ff, ENEMY_COLOR = 0xff3300, MED_COLOR = 0x00ff00, LOOT_COLOR = 0xffff00;

function startGame() {
    document.getElementById('menu').style.display = 'none';
    document.getElementById('ui').style.display = 'block';
    mapCtx = document.getElementById('map-canvas').getContext('2d');
    init();
}

function init() {
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x000205);
    clock = new THREE.Clock();
    camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 2000);
    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);
    
    scene.add(new THREE.AmbientLight(0xffffff, 0.4));
    const sun = new THREE.DirectionalLight(0xffffff, 0.8); sun.position.set(50, 150, 50); scene.add(sun);

    // Зона
    const zoneGeo = new THREE.CylinderGeometry(1, 1, 300, 64, 1, true);
    const zoneMat = new THREE.MeshBasicMaterial({ color: 0xff0000, transparent: true, opacity: 0.1, side: THREE.DoubleSide });
    zoneMesh = new THREE.Mesh(zoneGeo, zoneMat); scene.add(zoneMesh);

    // Генерация карты
    for (let i = 0; i < 40; i++) {
        let w = 15 + Math.random()*15, h = 10 + Math.random()*40;
        const b = new THREE.Mesh(new THREE.BoxGeometry(w, h, w), new THREE.MeshStandardMaterial({ color: 0x151515 }));
        b.position.set((Math.random()-0.5)*450, h/2, (Math.random()-0.5)*450);
        b.userData.box = new THREE.Box3().setFromObject(b);
        scene.add(b); buildings.push(b);

        if(Math.random() > 0.6) { // Пандусы
            const r = new THREE.Mesh(new THREE.BoxGeometry(8, 1, 30), new THREE.MeshStandardMaterial({ color: 0x222222 }));
            r.position.set(b.position.x + w/2 + 5, h/2 - 2, b.position.z);
            r.rotation.x = Math.PI / 8;
            r.userData.box = new THREE.Box3().setFromObject(r);
            scene.add(r); buildings.push(r);
        }
    }

    for (let i = 0; i < 15; i++) spawnMedkit();
    for (let i = 0; i < 10; i++) spawnLoot();

    player = createUnit(ALLY_COLOR, true, 0, "YOU");
    player.weapon = "PISTOL"; player.abilityActive = false;
    entities.push(player);

    for (let i = 1; i < 25; i++) {
        const bot = createUnit(ENEMY_COLOR, false, i, "ENEMY");
        bot.mesh.position.set((Math.random()-0.5)*400, 0, (Math.random()-0.5)*400);
        entities.push(bot);
    }

    startTime = Date.now();
    window.onkeydown = (e) => keys[e.code] = true;
    window.onkeyup = (e) => keys[e.code] = false;
    gameActive = true; animate();
}

function spawnMedkit() {
    const m = new THREE.Mesh(new THREE.BoxGeometry(2, 2, 2), new THREE.MeshStandardMaterial({ color: MED_COLOR, emissive: MED_COLOR }));
    m.position.set((Math.random()-0.5)*420, 1, (Math.random()-0.5)*420);
    scene.add(m); medkits.push(m);
}

function spawnLoot() {
    const type = Math.random() > 0.5 ? "AR" : "SG";
    const l = new THREE.Mesh(new THREE.BoxGeometry(3, 1.5, 3), new THREE.MeshStandardMaterial({ color: LOOT_COLOR, emissive: LOOT_COLOR, emissiveIntensity: 0.5 }));
    l.position.set((Math.random()-0.5)*420, 1, (Math.random()-0.5)*420);
    l.userData = { type }; scene.add(l); lootBoxes.push(l);
}

function createUnit(color, isPlayer = false, teamId, nameText) {
    const group = new THREE.Group();
    const body = new THREE.Mesh(new THREE.BoxGeometry(1.6, 3.2, 1.6), new THREE.MeshStandardMaterial({ color, transparent: true }));
    body.position.y = 1.6; group.add(body);
    const shield = new THREE.Mesh(new THREE.SphereGeometry(2.5, 16, 16), new THREE.MeshBasicMaterial({ color: 0xffffff, transparent: true, opacity: 0.2 }));
    shield.position.y = 1.6; group.add(shield);
    scene.add(group);
    const el = document.createElement('div'); el.className = 'nickname'; el.style.color = teamId === 0 ? "#00ffff" : "#ff4444"; document.body.appendChild(el);
    return { mesh: group, shield, body, hp: 200, maxHp: 200, isPlayer, lastShot: 0, teamId, label: el, nameBase: nameText, color: new THREE.Color(color), abilityActive: false, weapon: "PISTOL" };
}

function animate() {
    if (!gameActive) return; requestAnimationFrame(animate);
    const delta = clock.getDelta();
    const now = Date.now();

    zoneRadius -= 0.04; zoneMesh.scale.set(zoneRadius, 1, zoneRadius);

    // Способность M-1 (PHANTOM)
    if(keys['ShiftLeft'] && abilityCD <= 0 && player.isPlayer) {
        player.abilityActive = true; abilityCD = 8000;
        setTimeout(() => { player.abilityActive = false; }, 2000);
    }
    if(abilityCD > 0) abilityCD -= delta * 1000;
    document.getElementById('ability-status').innerText = abilityCD <= 0 ? "READY" : Math.ceil(abilityCD/1000) + "s";
    player.body.material.opacity = player.abilityActive ? 0.3 : 1.0;

    // Лут и Аптечки
    lootBoxes.forEach((l, i) => { if(player.mesh.position.distanceTo(l.position) < 3) { player.weapon = l.userData.type; document.getElementById('current-weapon').innerText = player.weapon; scene.remove(l); lootBoxes.splice(i, 1); setTimeout(spawnLoot, 15000); }});
    medkits.forEach((m, i) => { if(player.mesh.position.distanceTo(m.position) < 3) { player.hp = Math.min(200, player.hp + 60); scene.remove(m); medkits.splice(i, 1); setTimeout(spawnMedkit, 10000); }});

    entities.forEach(ent => {
        const oldPos = ent.mesh.position.clone();
        if (ent.isPlayer) {
            let speed = ent.abilityActive ? 0.8 : 0.5;
            if (keys['KeyW']) ent.mesh.translateZ(speed);
            if (keys['KeyS']) ent.mesh.translateZ(-speed);
            if (keys['KeyA']) ent.mesh.rotation.y += 0.07;
            if (keys['KeyD']) ent.mesh.rotation.y -= 0.07;
            
            let delay = ent.weapon === "AR" ? 150 : (ent.weapon === "SG" ? 800 : 250);
            if (keys['Space'] && !ent.abilityActive && now - ent.lastShot > delay) {
                if(ent.weapon === "SG") { for(let j=-2; j<=2; j++) spawnBullet(ent, j*0.15); }
                else spawnBullet(ent);
                ent.lastShot = now;
            }
        } else {
            ent.mesh.lookAt(player.mesh.position);
            if (ent.mesh.position.distanceTo(player.mesh.position) > 15) ent.mesh.translateZ(0.24);
            if (now - ent.lastShot > 1200) { spawnBullet(ent); ent.lastShot = now; }
        }

        const pBox = new THREE.Box3().setFromCenterAndSize(ent.mesh.position, new THREE.Vector3(2, 4, 2));
        for (let b of buildings) if (pBox.intersectsBox(b.userData.box)) ent.mesh.position.copy(oldPos);
        if (ent.mesh.position.length() > zoneRadius) ent.hp -= 0.6;
        ent.shield.visible = (now - startTime < 3000) || ent.abilityActive;
    });

    // Пули
    for (let i = bullets.length - 1; i >= 0; i--) {
        const b = bullets[i]; b.mesh.position.add(b.dir.clone().multiplyScalar(2.8));
        let hit = false;
        for (let target of entities) {
            if (target === b.owner || target.teamId === b.owner.teamId || target.abilityActive || (now - startTime < 3000)) continue;
            if (b.mesh.position.distanceTo(target.mesh.position.clone().add(new THREE.Vector3(0,1.6,0))) < 2.5) {
                target.hp -= (b.owner.weapon === "SG" ? 35 : 20); hit = true;
                if (b.owner.isPlayer && target.hp <= 0) score++; break;
            }
        }
        if (hit || b.mesh.position.length() > 800) { scene.remove(b.mesh); bullets.splice(i, 1); }
    }

    // Очистка мертвых
    for(let i=entities.length-1; i>=0; i--) {
        if(entities[i].hp <= 0) {
            if(entities[i].isPlayer) { alert("ВЫ ПОГИБЛИ. СЧЕТ: " + score); location.reload(); }
            entities[i].label.remove(); scene.remove(entities[i].mesh); entities.splice(i, 1);
        }
    }

    drawMinimap(); updateUI();
    camera.position.lerp(new THREE.Vector3(player.mesh.position.x, 75, player.mesh.position.z + 65), 0.1);
    camera.lookAt(player.mesh.position); renderer.render(scene, camera);
}

function spawnBullet(owner, angle = 0) {
    const b = new THREE.Mesh(new THREE.SphereGeometry(0.4), new THREE.MeshBasicMaterial({ color: owner.color }));
    b.position.copy(owner.mesh.position).add(new THREE.Vector3(0, 2.3, 0));
    let dir = new THREE.Vector3(0, 0, 1).applyQuaternion(owner.mesh.quaternion);
    if(angle !== 0) dir.applyAxisAngle(new THREE.Vector3(0,1,0), angle);
    bullets.push({ mesh: b, dir: dir.normalize(), owner }); scene.add(b);
}

function drawMinimap() {
    const s = 180, sc = s/600, c = s/2; mapCtx.clearRect(0,0,s,s);
    mapCtx.strokeStyle = "red"; mapCtx.beginPath(); mapCtx.arc(c - player.mesh.position.x*sc, c - player.mesh.position.z*sc, zoneRadius*sc, 0, Math.PI*2); mapCtx.stroke();
    entities.forEach(e => { mapCtx.fillStyle = e.isPlayer ? "#fff" : (e.teamId === 0 ? "#00f" : "#f00"); mapCtx.fillRect(c + (e.mesh.position.x-player.mesh.position.x)*sc-2, c + (e.mesh.position.z-player.mesh.position.z)*sc-2, 4, 4); });
    lootBoxes.forEach(l => { mapCtx.fillStyle = "#ff0"; mapCtx.fillRect(c + (l.position.x-player.mesh.position.x)*sc-2, c + (l.position.z-player.mesh.position.z)*sc-2, 3, 3); });
}

function updateUI() {
    entities.forEach(ent => {
        const v = ent.mesh.position.clone().add(new THREE.Vector3(0, 7, 0)).project(camera);
        if (v.z < 1.0) {
            ent.label.style.display = 'block';
            ent.label.style.left = `${(v.x * 0.5 + 0.5) * window.innerWidth}px`;
            ent.label.style.top = `${(-(v.y * 0.5 - 0.5) * window.innerHeight)}px`;
            ent.label.innerHTML = `${ent.nameBase} [${Math.floor(ent.hp)}]`;
        } else ent.label.style.display = 'none';
    });
    document.getElementById('hp-fill').style.width = (player.hp / 2) + "%";
    document.getElementById('kills').innerText = score;
}
</script>
</body>
</html>
