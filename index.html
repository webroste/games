<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Chaos Arena Fix</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; color: white; font-family: sans-serif; }
        #overlay { position: fixed; inset: 0; background: #111; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; }
        #error-log { position: fixed; top: 50px; width: 80%; color: #ff5555; font-family: monospace; text-align: center; }
        .btn { padding: 20px 50px; font-size: 28px; background: #00ff44; color: black; border: none; cursor: pointer; font-weight: bold; border-radius: 10px; }
        #ui { position: fixed; top: 10px; left: 10px; display: none; z-index: 10; font-family: monospace; }
        #hp-container { width: 200px; height: 20px; background: #300; border: 2px solid white; }
        #hp-bar { width: 100%; height: 100%; background: #0f0; }
        #fps { position: fixed; top: 10px; right: 10px; color: #0f0; }
    </style>
</head>
<body>

    <div id="overlay">
        <h1>CHAOS ARENA</h1>
        <div id="error-log"></div>
        <button class="btn" id="startBtn">ЗАПУСТИТЬ ИГРУ</button>
        <p>Если экран черный — проверьте, включен ли WebGL в браузере</p>
    </div>

    <div id="fps">FPS: --</div>
    <div id="ui">
        <div>HEALTH</div>
        <div id="hp-container"><div id="hp-bar"></div></div>
        <div id="score">Kills: 0</div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        const log = (msg) => { document.getElementById('error-log').innerText += "\n" + msg; };
        
        let scene, camera, renderer, player;
        let gameRunning = false;
        let hp = 100;
        let kills = 0;
        let zoneSize = 150;
        const enemies = [];
        const items = [];
        const keys = {};

        // 1. Ждем нажатия кнопки, чтобы избежать блокировки графики браузером
        document.getElementById('startBtn').addEventListener('click', () => {
            try {
                initGame();
                document.getElementById('overlay').style.display = 'none';
                document.getElementById('ui').style.display = 'block';
                gameRunning = true;
                animate();
            } catch (e) {
                log("Ошибка запуска: " + e.message);
            }
        });

        function initGame() {
            // Инициализация сцены
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x050505);

            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
            
            // Настройка рендера с проверкой на ошибки
            renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "high-performance" });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            const ambient = new THREE.AmbientLight(0xffffff, 0.4);
            scene.add(ambient);
            const sun = new THREE.PointLight(0xffffff, 1, 500);
            sun.position.set(0, 50, 0);
            scene.add(sun);

            // Пол
            const floor = new THREE.Mesh(
                new THREE.PlaneGeometry(500, 500),
                new THREE.MeshStandardMaterial({ color: 0x111111 })
            );
            floor.rotation.x = -Math.PI / 2;
            scene.add(floor);

            // Создаем игрока
            player = new THREE.Group();
            const body = new THREE.Mesh(new THREE.BoxGeometry(1.5, 3, 1.5), new THREE.MeshStandardMaterial({ color: 0x00ccff }));
            body.position.y = 1.5;
            const eye = new THREE.Mesh(new THREE.BoxGeometry(1.6, 0.5, 0.5), new THREE.MeshStandardMaterial({ color: 0xffffff }));
            eye.position.set(0, 2.5, 0.6);
            player.add(body, eye);
            scene.add(player);

            window.addEventListener('keydown', e => keys[e.code] = true);
            window.addEventListener('keyup', e => keys[e.code] = false);
            window.addEventListener('resize', onWindowResize);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function spawnEnemy() {
            const enemy = new THREE.Mesh(new THREE.BoxGeometry(2, 2, 2), new THREE.MeshStandardMaterial({ color: 0xff0044 }));
            const angle = Math.random() * Math.PI * 2;
            const dist = zoneSize - 5;
            enemy.position.set(Math.cos(angle)*dist, 1, Math.sin(angle)*dist);
            scene.add(enemy);
            enemies.push(enemy);
        }

        let lastFrameTime = 0;
        let frameCount = 0;

        function animate(time) {
            if (!gameRunning) return;
            requestAnimationFrame(animate);

            // Счётчик FPS
            frameCount++;
            if (time > lastFrameTime + 1000) {
                document.getElementById('fps').innerText = "FPS: " + frameCount;
                frameCount = 0;
                lastFrameTime = time;
                if(enemies.length < 15) spawnEnemy();
            }

            // Управление
            let dx = 0, dz = 0;
            if (keys['KeyW']) dz -= 1; if (keys['KeyS']) dz += 1;
            if (keys['KeyA']) dx -= 1; if (keys['KeyD']) dx += 1;
            
            if (dx !== 0 || dz !== 0) {
                const moveSpeed = 0.4;
                player.position.x += dx * moveSpeed;
                player.position.z += dz * moveSpeed;
                player.rotation.y = Math.atan2(dx, dz);
            }

            // Сужение зоны
            zoneSize -= 0.01;
            const playerDist = Math.sqrt(player.position.x**2 + player.position.z**2);
            if (playerDist > zoneSize) {
                hp -= 0.1;
                scene.background = new THREE.Color(0x330000); // Экран краснеет
            } else {
                scene.background = new THREE.Color(0x050505);
            }

            // Бой (Space)
            if (keys['Space']) {
                enemies.forEach((en, i) => {
                    if (player.position.distanceTo(en.position) < 6) {
                        scene.remove(en);
                        enemies.splice(i, 1);
                        kills++;
                        document.getElementById('score').innerText = "Kills: " + kills;
                    }
                });
            }

            // ИИ врагов
            enemies.forEach(en => {
                en.lookAt(player.position);
                en.translateZ(0.15);
                if (en.position.distanceTo(player.position) < 2) hp -= 0.2;
            });

            // HP Bar
            document.getElementById('hp-bar').style.width = hp + "%";
            if (hp <= 0) {
                alert("GAME OVER! KILLS: " + kills);
                location.reload();
            }

            // Камера
            camera.position.set(player.position.x, 40, player.position.z + 30);
            camera.lookAt(player.position);

            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
