<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Chaos Arena v17: Loot & Exploration</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Courier New', monospace; color: #00ffff; user-select: none; }
        #menu { 
            position: fixed; inset: 0; 
            background: radial-gradient(circle at 20% 50%, #001020 0%, #000 100%); 
            display: flex; flex-direction: column; align-items: flex-start; justify-content: center; 
            z-index: 1000; padding-left: 5%; border-left: 10px solid #00ffff; 
        }
        .menu-title { font-size: 50px; text-shadow: 0 0 20px #00ffff; margin-bottom: 40px; }
        .btn { 
            background: rgba(0, 0, 0, 0.7); color: #00ffff; border: 2px solid #00ffff; 
            padding: 15px 30px; font-size: 18px; cursor: pointer; margin: 10px 0; 
            transition: 0.3s; width: 320px; text-align: left; font-weight: bold; 
            text-transform: uppercase;
        }
        .btn:hover { background: #00ffff; color: #000; box-shadow: 0 0 25px #00ffff; transform: translateX(10px); }
        #version-tag { position: fixed; bottom: 10px; right: 15px; font-size: 12px; color: rgba(0, 255, 255, 0.5); z-index: 1001; }
        #hero-selection { position: fixed; inset: 50px; background: rgba(0,10,20,0.95); border: 3px solid #00ffff; display: none; z-index: 1100; padding: 20px; }
        .hero-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 15px; }
        .hero-item { padding: 20px; border: 1px solid #00ffff; text-align: center; cursor: pointer; }
        #ui { position: fixed; inset: 0; pointer-events: none; z-index: 10; display: none; padding: 20px; }
        #hp-bar { width: 350px; height: 20px; background: #200; border: 2px solid #00ffff; position: absolute; bottom: 40px; left: 40px; }
        #hp-fill { width: 100%; height: 100%; background: #00ffff; transition: 0.3s; }
        #stats { position: absolute; top: 20px; right: 30px; text-align: right; font-size: 20px; }
        .nickname { position: absolute; font-weight: bold; font-size: 11px; text-shadow: 2px 2px 2px black; pointer-events: none; text-align: center; }
    </style>
</head>
<body>

<div id="version-tag">CHAOS ARENA BUILD: v0.17.loot</div>
<div id="menu">
    <div class="menu-title">CHAOS ARENA</div>
    <div class="btn" onclick="startGame()">НАЧАТЬ МИССИЮ</div>
    <div class="btn" onclick="openHeroSelect()">ГЕРОЙ: <span id="hero-display">M-1</span></div>
    <div class="btn" style="border-color:#8000ff; color:#8000ff;" id="btn-mode" onclick="toggleMode()">РЕЖИМ: СОЛО</div>
</div>

<div id="hero-selection">
    <h2>АРСЕНАЛ ОПЕРАТИВНИКОВ</h2>
    <div class="hero-grid" id="hero-grid"></div>
    <div class="btn" style="width: 150px; margin-top:20px;" onclick="closeHeroSelect()">ЗАКРЫТЬ</div>
</div>

<div id="ui">
    <div id="hp-bar"><div id="hp-fill"></div></div>
    <div id="stats">УСТРАНЕНО: <span id="kills">0</span> | В ЖИВЫХ: <span id="alive">0</span></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
let scene, camera, renderer, player, clock;
let gameActive = false, entities = [], bullets = [], buildings = [], medkits = [];
let keys = {}, score = 0, zoneMesh, zoneRadius = 200;
let modes = ["СОЛО", "ДУО", "ОТРЯД"], currentModeIndex = 0;
let selectedHeroId = 1;

const ALLY_COLOR = 0x0066ff, ENEMY_COLOR = 0xff3300, MEDKIT_COLOR = 0x00ff00;

function toggleMode() {
    currentModeIndex = (currentModeIndex + 1) % modes.length;
    document.getElementById('btn-mode').innerText = "РЕЖИМ: " + modes[currentModeIndex];
}

for(let i=1; i<=10; i++) {
    const item = document.createElement('div');
    item.className = 'hero-item';
    item.innerText = "M-" + i;
    item.onclick = () => { selectedHeroId = i; document.getElementById('hero-display').innerText = "M-" + i; closeHeroSelect(); };
    document.getElementById('hero-grid').appendChild(item);
}

function openHeroSelect() { document.getElementById('hero-selection').style.display = 'block'; }
function closeHeroSelect() { document.getElementById('hero-selection').style.display = 'none'; }

function startGame() {
    document.getElementById('menu').style.display = 'none';
    document.getElementById('ui').style.display = 'block';
    init();
}

function init() {
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x000205);
    clock = new THREE.Clock();
    camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);
    
    scene.add(new THREE.AmbientLight(0xffffff, 0.5));
    const sun = new THREE.DirectionalLight(0xffffff, 0.8);
    sun.position.set(100, 200, 100);
    scene.add(sun);

    // Зона
    const zoneGeo = new THREE.CylinderGeometry(1, 1, 100, 64, 1, true);
    const zoneMat = new THREE.MeshBasicMaterial({ color: 0xff0000, transparent: true, opacity: 0.1, side: THREE.DoubleSide });
    zoneMesh = new THREE.Mesh(zoneGeo, zoneMat);
    scene.add(zoneMesh);

    // Генерация города (Этап 3)
    for (let i = 0; i < 50; i++) {
        const w = 8 + Math.random() * 10;
        const h = 10 + Math.random() * 40;
        const b = new THREE.Mesh(new THREE.BoxGeometry(w, h, w), new THREE.MeshStandardMaterial({ color: 0x111111 }));
        b.position.set((Math.random()-0.5)*400, h/2, (Math.random()-0.5)*400);
        b.userData.box = new THREE.Box3().setFromObject(b);
        scene.add(b);
        buildings.push(b);
    }

    // Спавн аптечек (Этап 3)
    for (let i = 0; i < 15; i++) spawnMedkit();

    // Игрок
    player = createUnit(ALLY_COLOR, true, 0, "YOU (M-" + selectedHeroId + ")");
    entities.push(player);

    // Рассредоточенный спавн (Этап 3)
    let teamSize = (currentModeIndex === 0) ? 1 : (currentModeIndex === 1 ? 2 : 4);
    for (let i = 1; i < 25; i++) {
        let teamId = Math.floor(i / teamSize);
        let isAlly = (teamId === 0);
        const bot = createUnit(isAlly ? ALLY_COLOR : ENEMY_COLOR, false, teamId, isAlly ? "ALLY" : "ENEMY");
        let spawned = false;
        while (!spawned) {
            // Враги теперь спавнятся по всей карте (до 400 метров)
            let range = isAlly ? 40 : 380;
            let rx = (Math.random()-0.5)*range, rz = (Math.random()-0.5)*range;
            bot.mesh.position.set(rx, 0, rz);
            if (!checkWall(bot.mesh.position)) { entities.push(bot); spawned = true; }
        }
    }

    window.onkeydown = (e) => keys[e.code] = true;
    window.onkeyup = (e) => keys[e.code] = false;
    gameActive = true;
    animate();
}

function spawnMedkit() {
    const m = new THREE.Mesh(new THREE.BoxGeometry(1.5, 1.5, 1.5), new THREE.MeshStandardMaterial({ color: MEDKIT_COLOR, emissive: MEDKIT_COLOR, emissiveIntensity: 0.5 }));
    let spawned = false;
    while(!spawned) {
        let x = (Math.random()-0.5)*350, z = (Math.random()-0.5)*350;
        m.position.set(x, 0.75, z);
        if(!checkWall(m.position)) { scene.add(m); medkits.push(m); spawned = true; }
    }
}

function createUnit(color, isPlayer = false, teamId, nameText) {
    const group = new THREE.Group();
    const body = new THREE.Mesh(new THREE.BoxGeometry(1.6, 3.2, 1.6), new THREE.MeshStandardMaterial({ color }));
    body.position.y = 1.6; group.add(body);
    const gun = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.5, 1.4), new THREE.MeshStandardMaterial({ color: 0x111111 }));
    gun.position.set(0.8, 2.3, 0.8); group.add(gun);
    scene.add(group);

    const el = document.createElement('div');
    el.className = 'nickname';
    el.style.color = teamId === 0 ? "#00ffff" : "#ff4444";
    document.body.appendChild(el);

    return { mesh: group, hp: 200, maxHp: 200, isPlayer, lastShot: 0, teamId, label: el, nameBase: nameText, color: new THREE.Color(color) };
}

function checkWall(pos) {
    const pBox = new THREE.Box3().setFromCenterAndSize(pos, new THREE.Vector3(2, 4, 2));
    for (let b of buildings) if (pBox.intersectsBox(b.userData.box)) return true;
    return false;
}

function animate() {
    if (!gameActive) return;
    requestAnimationFrame(animate);
    const time = clock.getElapsedTime();

    zoneRadius -= 0.008; if(zoneRadius < 5) zoneRadius = 5;
    zoneMesh.scale.set(zoneRadius, 1, zoneRadius);

    // Логика аптечек
    for (let i = medkits.length - 1; i >= 0; i--) {
        const m = medkits[i];
        m.rotation.y += 0.02;
        entities.forEach(ent => {
            if (ent.mesh.position.distanceTo(m.position) < 2.5) {
                ent.hp = Math.min(ent.maxHp, ent.hp + 50);
                scene.remove(m);
                medkits.splice(i, 1);
                setTimeout(spawnMedkit, 10000); // Респавн через 10 сек
            }
        });
    }

    for (let i = entities.length - 1; i >= 0; i--) {
        const ent = entities[i];
        const oldPos = ent.mesh.position.clone();

        if (ent.isPlayer) {
            ent.isMoving = false;
            if (keys['KeyW']) { ent.mesh.translateZ(0.5); ent.isMoving = true; }
            if (keys['KeyS']) { ent.mesh.translateZ(-0.5); ent.isMoving = true; }
            if (keys['KeyA']) ent.mesh.rotation.y += 0.06;
            if (keys['KeyD']) ent.mesh.rotation.y -= 0.06;
            if (keys['Space'] && Date.now() - ent.lastShot > 250) { spawnBullet(ent); ent.lastShot = Date.now(); }
        } else {
            // ИИ ботов (упрощенный поиск аптечки)
            let target = null;
            if (ent.hp < 100 && medkits.length > 0) {
                let nearestMed = medkits[0];
                if (ent.mesh.position.distanceTo(nearestMed.position) < 50) target = nearestMed;
            }

            if (!target) {
                let dMin = 150;
                entities.forEach(other => {
                    if (other.teamId !== ent.teamId) {
                        let d = ent.mesh.position.distanceTo(other.mesh.position);
                        if (d < dMin) { dMin = d; target = other; }
                    }
                });
            }

            if (target) {
                ent.mesh.lookAt(target.position || target.mesh.position);
                ent.mesh.translateZ(0.18);
                ent.isMoving = true;
                if (!target.position && ent.mesh.position.distanceTo(target.mesh.position) < 20) {
                    if (Date.now() - ent.lastShot > 1200) { spawnBullet(ent); ent.lastShot = Date.now(); }
                }
            }
        }

        if (checkWall(ent.mesh.position)) ent.mesh.position.copy(oldPos);
        if (ent.mesh.position.length() > zoneRadius) ent.hp -= 0.3;

        if (ent.hp <= 0) {
            if (ent.isPlayer) { alert("ВЫ ПОГИБЛИ!"); location.reload(); return; }
            ent.label.remove(); scene.remove(ent.mesh); entities.splice(i, 1);
            continue;
        }
    }

    // Пули
    for (let i = bullets.length - 1; i >= 0; i--) {
        const b = bullets[i];
        b.mesh.position.add(b.dir.clone().multiplyScalar(2.2));
        let hit = false;
        for (let wall of buildings) if (wall.userData.box.containsPoint(b.mesh.position)) { hit = true; break; }
        if (!hit) {
            for (let target of entities) {
                if (target === b.owner || target.teamId === b.owner.teamId) continue;
                if (b.mesh.position.distanceTo(target.mesh.position.clone().add(new THREE.Vector3(0,1.6,0))) < 2.5) {
                    target.hp -= 25; hit = true;
                    if (b.owner.isPlayer && target.hp <= 0) score++;
                    break;
                }
            }
        }
        if (hit || b.mesh.position.length() > 500) { scene.remove(b.mesh); bullets.splice(i, 1); }
    }

    // UI
    entities.forEach(ent => {
        const v = ent.mesh.position.clone().add(new THREE.Vector3(0, 5, 0));
        v.project(camera);
        if (v.z < 1.0) {
            ent.label.style.display = 'block';
            ent.label.style.left = `${(v.x * 0.5 + 0.5) * window.innerWidth}px`;
            ent.label.style.top = `${(-(v.y * 0.5 - 0.5) * window.innerHeight)}px`;
            ent.label.innerHTML = `${ent.nameBase}<br>${Math.floor(ent.hp)} HP`;
        } else ent.label.style.display = 'none';
    });

    document.getElementById('hp-fill').style.width = (player.hp / player.maxHp * 100) + "%";
    document.getElementById('kills').innerText = score;
    document.getElementById('alive').innerText = entities.length;
    camera.position.lerp(new THREE.Vector3(player.mesh.position.x, 55, player.mesh.position.z + 45), 0.1);
    camera.lookAt(player.mesh.position);
    renderer.render(scene, camera);
}

function spawnBullet(owner) {
    const b = new THREE.Mesh(new THREE.SphereGeometry(0.4), new THREE.MeshBasicMaterial({ color: owner.color }));
    b.position.copy(owner.mesh.position).add(new THREE.Vector3(0, 2.3, 0));
    const dir = new THREE.Vector3(0, 0, 1).applyQuaternion(owner.mesh.quaternion).normalize();
    bullets.push({ mesh: b, dir, owner });
    scene.add(b);
}
</script>
</body>
</html>
