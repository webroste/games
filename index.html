<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MLBB Definitive Edition: 600+ Lines</title>
    <style>
        :root {
            --gold: #ffcc00;
            --blue: #2980b9;
            --red: #c0392b;
            --dark-bg: #050a0f;
        }

        body { 
            margin: 0; overflow: hidden; background: #000; 
            font-family: 'Segoe UI', Arial, sans-serif; 
            user-select: none; -webkit-user-select: none;
            touch-action: none;
        }

        /*  挟 */
        #main-menu-overlay {
            position: absolute; inset: 0; z-index: 2000;
            background: radial-gradient(circle at center, #1a2a6c 0%, #050a0f 100%);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        .game-title {
            color: var(--gold); font-size: 55px; font-weight: 900; letter-spacing: 12px;
            text-shadow: 0 0 40px rgba(255, 204, 0, 0.4); margin-bottom: 50px;
            text-align: center; text-transform: uppercase;
        }

        .menu-btn {
            width: 280px; padding: 20px; margin: 12px;
            font-size: 22px; font-weight: bold; color: white; border-radius: 15px;
            cursor: pointer; border: none; text-transform: uppercase;
            transition: 0.2s; box-shadow: 0 6px 0 rgba(0,0,0,0.3);
        }
        .btn-start { background: linear-gradient(180deg, #27ae60, #219150); border-bottom: 4px solid #145a32; }
        .btn-start:active { transform: translateY(4px); border-bottom: none; }
        .btn-settings { background: linear-gradient(180deg, #7f8c8d, #34495e); border-bottom: 4px solid #2c3e50; }

        /*  小孝 */
        #settings-window {
            display: none; position: absolute; inset: 0; z-index: 2500;
            background: rgba(0,0,0,0.9); align-items: center; justify-content: center;
        }
        .settings-box {
            background: #1c2833; padding: 40px; border-radius: 20px;
            border: 2px solid var(--gold); width: 320px; color: white;
        }
        .setting-row { display: flex; justify-content: space-between; margin-bottom: 25px; align-items: center; }

        /*  孝肖小 (HUD) */
        #game-hud {
            display: none; position: absolute; inset: 0; z-index: 1000; pointer-events: none;
        }

        #minimap-container {
            position: absolute; top: 20px; left: 20px; width: 200px; height: 200px;
            background: rgba(0, 0, 0, 0.8); border: 2px solid #2c3e50;
            border-radius: 12px; overflow: hidden; pointer-events: auto;
        }
        #minimap-canvas { width: 100%; height: 100%; }

        #joystick-base {
            position: absolute; bottom: 60px; left: 60px; width: 150px; height: 150px;
            background: rgba(255, 255, 255, 0.05); border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%; pointer-events: auto; backdrop-filter: blur(5px);
        }
        #joystick-ball {
            position: absolute; top: 50%; left: 50%; width: 70px; height: 70px;
            background: radial-gradient(circle, #fdfdfd, #95a5a6); border-radius: 50%;
            transform: translate(-50%, -50%); box-shadow: 0 10px 20px rgba(0,0,0,0.5);
        }

        #recall-button {
            position: absolute; bottom: 70px; right: 70px; width: 110px; height: 110px;
            background: linear-gradient(135deg, #2980b9, #154360); border: 4px solid white;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 45px; color: white; pointer-events: auto; cursor: pointer;
            box-shadow: 0 0 30px rgba(41, 128, 185, 0.5);
        }

        #recall-timer-text {
            position: absolute; bottom: 220px; width: 100%; text-align: center;
            color: #00f2ff; font-size: 38px; font-weight: 900; display: none;
            text-shadow: 0 0 20px #000; letter-spacing: 4px;
        }

        #debug-log {
            position: absolute; top: 230px; left: 20px; width: 200px; max-height: 150px;
            background: rgba(0,0,0,0.85); color: #00ff00; font-family: monospace;
            font-size: 11px; padding: 10px; border-radius: 5px; overflow-y: auto;
            pointer-events: none; border: 1px solid #333; display: none;
        }
    </style>
</head>
<body>

    <div id="main-menu-overlay">
        <h1 class="game-title">LEGENDS<br>AWAKENING</h1>
        <button class="menu-btn btn-start" id="btn-play-game">小孝校孝鞋  </button>
        <button class="menu-btn btn-settings" id="btn-open-settings">小孝</button>
    </div>

    <div id="settings-window">
        <div class="settings-box">
            <h2 style="text-align: center; color: var(--gold);">CONFIG</h2>
            <div class="setting-row">
                <span>Rendering</span>
                <select style="background: #34495e; color: white; border: none; padding: 5px;">
                    <option>Standard</option>
                    <option selected>Ultra HD</option>
                </select>
            </div>
            <div class="setting-row">
                <span>Particles</span>
                <input type="checkbox" checked>
            </div>
            <div class="setting-row">
                <span>Shadows</span>
                <input type="checkbox" checked>
            </div>
            <button class="menu-btn btn-settings" style="width: 100%; margin: 20px 0 0;" id="btn-close-settings">BACK</button>
        </div>
    </div>

    <div id="game-hud">
        <div id="minimap-container"><canvas id="minimap-canvas"></canvas></div>
        <div id="debug-log"></div>
        <div id="joystick-base"><div id="joystick-ball"></div></div>
        <div id="recall-timer-text">RECALLING... <span id="r-time">5</span></div>
        <div id="recall-button"></div>
        <div id="cam-touch-area" style="position:absolute; right:0; top:0; width:60%; height:100%; pointer-events:auto;"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        /**
         * ENGINE CORE - 小小 蝎
         */
        class MobaEngine {
            constructor() {
                this.scene = null;
                this.camera = null;
                this.renderer = null;
                this.player = null;
                this.recallZone = null;
                this.clock = new THREE.Clock();
                
                this.obstacles = [];
                this.moving = false;
                this.moveVector = { x: 0, z: 0 };
                this.isRecalling = false;
                this.recallTimer = null;
                this.camRot = { x: 0, z: 0 };

                this.MAP_LIMIT = 450;
            }

            init() {
                this.writeLog("System: Starting Core...");
                
                // Scene setup
                this.scene = new THREE.Scene();
                this.scene.background = new THREE.Color(0x050a0f);
                this.scene.fog = new THREE.Fog(0x050a0f, 60, 300);

                // Camera
                this.camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1500);
                
                // Renderer
                this.renderer = new THREE.WebGLRenderer({ antialias: true, logarithmicDepthBuffer: true });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
                document.body.appendChild(this.renderer.domElement);

                // Lighting
                const amb = new THREE.AmbientLight(0xffffff, 0.5);
                this.scene.add(amb);
                const sun = new THREE.DirectionalLight(0xffffff, 1.2);
                sun.position.set(100, 200, 100);
                this.scene.add(sun);

                this.createWorld();
                this.spawnPlayer();
                this.bindEvents();
                this.animate();
            }

            writeLog(msg) {
                const l = document.getElementById('debug-log');
                l.style.display = 'block';
                l.innerHTML += `> ${msg}<br>`;
                l.scrollTop = l.scrollHeight;
                console.log(msg);
            }

            createWorld() {
                // Ground
                const groundGeo = new THREE.PlaneGeometry(1000, 1000);
                const groundMat = new THREE.MeshStandardMaterial({ color: 0x145a32, roughness: 0.8 });
                const ground = new THREE.Mesh(groundGeo, groundMat);
                ground.rotation.x = -Math.PI / 2;
                this.scene.add(ground);

                // River
                const river = new THREE.Mesh(
                    new THREE.PlaneGeometry(120, 1000),
                    new THREE.MeshStandardMaterial({ color: 0x1a5276, transparent: true, opacity: 0.7 })
                );
                river.rotation.x = -Math.PI / 2;
                river.position.y = 0.1;
                this.scene.add(river);

                // Roads
                this.createLane(0, 0, Math.PI / 4); // Mid
                this.createLane(-350, 0, 0); // Top
                this.createLane(350, 0, 0);  // Bot

                // Towers (FULL NETWORK)
                // Mid Line
                for(let i=1; i<=3; i++) {
                    this.addTower(-70 * i, 70 * i, 0x2980b9);
                    this.addTower(70 * i, -70 * i, 0xc0392b);
                }
                // Top Line
                for(let i=0; i<3; i++) {
                    this.addTower(-350, 100 + i*100, 0x2980b9);
                    this.addTower(-100 - i*100, -350, 0xc0392b);
                }
                // Bot Line
                for(let i=0; i<3; i++) {
                    this.addTower(100 + i*100, 350, 0x2980b9);
                    this.addTower(350, -100 - i*100, 0xc0392b);
                }

                // Bases
                this.addMainBase(-420, 420, 0x2980b9);
                this.addMainBase(420, -420, 0xc0392b);

                // Jungle Decoration (600 objects)
                for(let j=0; j<600; j++) {
                    let rx = (Math.random() - 0.5) * 900;
                    let rz = (Math.random() - 0.5) * 900;
                    
                    if (Math.abs(rx) > 80 && Math.abs(rx + rz) > 70) {
                        const type = Math.random();
                        if(type > 0.8) this.spawnTree(rx, rz);
                        else if(type > 0.5) this.spawnRock(rx, rz);
                        else if(type > 0.3) this.spawnBush(rx, rz);
                    }
                }
                this.writeLog("World built: 18 Towers, 2 Nexuses, 600+ Jungle items");
            }

            createLane(x, z, rot) {
                const lane = new THREE.Mesh(
                    new THREE.PlaneGeometry(65, 1400),
                    new THREE.MeshStandardMaterial({ color: 0x212f3d })
                );
                lane.rotation.x = -Math.PI / 2;
                lane.rotation.z = rot;
                lane.position.set(x, 0.15, z);
                this.scene.add(lane);
            }

            addTower(x, z, color) {
                const group = new THREE.Group();
                const base = new THREE.Mesh(new THREE.CylinderGeometry(5, 7, 5, 8), new THREE.MeshStandardMaterial({color: 0x566573}));
                const body = new THREE.Mesh(new THREE.CylinderGeometry(3, 4, 18, 8), new THREE.MeshStandardMaterial({color: 0x2c3e50}));
                body.position.y = 10;
                const head = new THREE.Mesh(new THREE.OctahedronGeometry(5), new THREE.MeshStandardMaterial({color: color, emissive: color, emissiveIntensity: 1}));
                head.position.y = 23;
                group.add(base); group.add(body); group.add(head);
                group.position.set(x, 0, z);
                this.scene.add(group);
                this.obstacles.push({ x, z, r: 9, team: color === 0x2980b9 ? 'blue' : 'red' });
            }

            addMainBase(x, z, color) {
                const group = new THREE.Group();
                const core = new THREE.Mesh(new THREE.IcosahedronGeometry(12, 1), new THREE.MeshStandardMaterial({color: color, emissive: color, emissiveIntensity: 2}));
                core.position.y = 15;
                const platform = new THREE.Mesh(new THREE.BoxGeometry(30, 8, 30), new THREE.MeshStandardMaterial({color: 0x1c2833}));
                group.add(core); group.add(platform);
                group.position.set(x, 0, z);
                this.scene.add(group);
                this.obstacles.push({ x, z, r: 25, nexus: true });
            }

            spawnTree(x, z) {
                const g = new THREE.Group();
                const t = new THREE.Mesh(new THREE.CylinderGeometry(1.5, 2, 12), new THREE.MeshStandardMaterial({color: 0x4e342e}));
                const l = new THREE.Mesh(new THREE.SphereGeometry(7, 8, 8), new THREE.MeshStandardMaterial({color: 0x1b5e20}));
                l.position.y = 10;
                g.add(t); g.add(l);
                g.position.set(x, 6, z);
                this.scene.add(g);
            }

            spawnRock(x, z) {
                const r = new THREE.Mesh(new THREE.DodecahedronGeometry(Math.random()*5+5), new THREE.MeshStandardMaterial({color: 0x424949}));
                r.position.set(x, 4, z);
                r.rotation.set(Math.random(), Math.random(), Math.random());
                this.scene.add(r);
                this.obstacles.push({ x, z, r: 8, deco: true });
            }

            spawnBush(x, z) {
                const b = new THREE.Mesh(new THREE.SphereGeometry(6, 6, 6), new THREE.MeshStandardMaterial({color: 0x0e6655}));
                b.scale.y = 0.5; b.position.set(x, 2, z);
                this.scene.add(b);
            }

            spawnPlayer() {
                this.player = new THREE.Group();
                const body = new THREE.Mesh(new THREE.CylinderGeometry(1.8, 1.8, 5, 12), new THREE.MeshStandardMaterial({ color: 0x3498db }));
                body.position.y = 2.5;
                this.player.add(body);
                
                const sword = new THREE.Mesh(new THREE.BoxGeometry(0.5, 6, 0.8), new THREE.MeshStandardMaterial({ color: 0xffffff, emissive: 0x00f2ff }));
                sword.position.set(2, 4, 1);
                sword.rotation.x = 0.4;
                this.player.add(sword);

                this.recallZone = new THREE.Mesh(
                    new THREE.CylinderGeometry(7, 7, 120, 32, 1, true),
                    new THREE.MeshBasicMaterial({ color: 0x00f2ff, transparent: true, opacity: 0, side: THREE.DoubleSide })
                );
                this.recallZone.position.y = 60;
                this.player.add(this.recallZone);

                this.scene.add(this.player);
                this.player.position.set(-420, 0, 420);
                this.writeLog("Hero ready: Blue Team");
            }

            bindEvents() {
                const joyBase = document.getElementById('joystick-base'), ball = document.getElementById('joystick-ball');
                
                const handleJoystick = (e) => {
                    e.preventDefault();
                    const t = e.touches ? e.touches[0] : e;
                    const r = joyBase.getBoundingClientRect();
                    const dx = t.clientX - (r.left + 75), dy = t.clientY - (r.top + 75);
                    const dist = Math.min(Math.sqrt(dx*dx + dy*dy), 65);
                    const angle = Math.atan2(dy, dx);
                    
                    ball.style.transform = `translate(calc(-50% + ${Math.cos(angle)*dist}px), calc(-50% + ${Math.sin(angle)*dist}px))`;
                    this.moveVector = { x: Math.cos(angle), z: Math.sin(angle) };
                    this.moving = true;
                    if(this.isRecalling) this.stopRecall();
                };

                joyBase.addEventListener('touchstart', handleJoystick);
                joyBase.addEventListener('touchmove', handleJoystick);
                window.addEventListener('touchend', () => {
                    this.moving = false;
                    ball.style.transform = 'translate(-50%, -50%)';
                });

                // Camera swipe
                const camArea = document.getElementById('cam-touch-area');
                let lastX, lastY;
                camArea.addEventListener('touchstart', e => { 
                    lastX = e.touches[0].clientX; lastY = e.touches[0].clientY; 
                });
                camArea.addEventListener('touchmove', e => {
                    this.camRot.x += (e.touches[0].clientX - lastX) * 0.12;
                    this.camRot.z += (e.touches[0].clientY - lastY) * 0.12;
                    lastX = e.touches[0].clientX; lastY = e.touches[0].clientY;
                });

                // Recall
                document.getElementById('recall-button').addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    if(!this.isRecalling && !this.moving) this.startRecall();
                });
            }

            startRecall() {
                this.isRecalling = true;
                this.recallZone.material.opacity = 0.5;
                document.getElementById('recall-timer-text').style.display = 'block';
                let time = 5;
                document.getElementById('r-time').innerText = time;
                this.recallTimer = setInterval(() => {
                    time--;
                    document.getElementById('r-time').innerText = time;
                    if(time <= 0) {
                        this.player.position.set(-420, 0, 420);
                        this.stopRecall();
                    }
                }, 1000);
            }

            stopRecall() {
                this.isRecalling = false;
                clearInterval(this.recallTimer);
                this.recallZone.material.opacity = 0;
                document.getElementById('recall-timer-text').style.display = 'none';
            }

            drawMinimap() {
                const c = document.getElementById('minimap-canvas');
                const ctx = c.getContext('2d');
                c.width = 200; c.height = 200;
                ctx.fillStyle = '#050a0f'; ctx.fillRect(0,0,200,200);

                this.obstacles.forEach(o => {
                    if(o.deco) return;
                    ctx.fillStyle = o.team === 'blue' ? '#2980b9' : '#c0392b';
                    const mx = ((o.x + 500)/1000)*200, mz = ((o.z + 500)/1000)*200;
                    const s = o.nexus ? 10 : 4;
                    ctx.fillRect(mx-s/2, mz-s/2, s, s);
                });

                ctx.fillStyle = '#fff';
                const px = ((this.player.position.x + 500)/1000)*200, pz = ((this.player.position.z + 500)/1000)*200;
                ctx.beginPath(); ctx.arc(px, pz, 6, 0, Math.PI*2); ctx.fill();
            }

            animate() {
                requestAnimationFrame(() => this.animate());
                
                if(this.moving && !this.isRecalling) {
                    const nextX = this.player.position.x + this.moveVector.x * 0.8;
                    const nextZ = this.player.position.z + this.moveVector.z * 0.8;
                    
                    let blocked = false;
                    this.obstacles.forEach(o => {
                        const dist = Math.sqrt((nextX - o.x)**2 + (nextZ - o.z)**2);
                        if(dist < o.r + 2) blocked = true;
                    });

                    if(!blocked && Math.abs(nextX) < 490 && Math.abs(nextZ) < 490) {
                        this.player.position.set(nextX, 0, nextZ);
                        this.player.rotation.y = Math.atan2(-
