<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MOBA Legends: Hardcore Edition</title>
    <style>
        body { 
            margin: 0; 
            overflow: hidden; 
            background: #000; 
            touch-action: none; 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            user-select: none; 
            -webkit-user-select: none;
        }

        /* –£–õ–£–ß–®–ï–ù–ù–ê–Ø –î–ï–ë–ê–ì-–ö–û–ù–°–û–õ–¨ */
        #debug-log {
            position: absolute; 
            top: 10px; 
            left: 10px; 
            width: 280px; 
            max-height: 200px;
            background: rgba(0, 0, 0, 0.85); 
            color: #00ffcc; 
            font-family: 'Consolas', monospace; 
            font-size: 11px;
            padding: 12px; 
            border-radius: 8px; 
            overflow-y: auto; 
            z-index: 10000;
            display: none; 
            border: 1px solid #00ffcc;
            pointer-events: none;
            box-shadow: 0 0 15px rgba(0, 255, 204, 0.3);
        }

        .screen { 
            position: absolute; 
            inset: 0; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            z-index: 10; 
        }

        /* –ú–ï–ù–Æ –ò –ù–ê–°–¢–†–û–ô–ö–ò */
        #menu-screen { 
            background: radial-gradient(circle at center, #1e3a8a, #000); 
        }
        
        #settings-screen { 
            background: rgba(10, 10, 10, 0.95); 
            display: none; 
            color: white; 
            z-index: 1000; 
        }

        h1 { 
            color: #fbbf24; 
            font-size: 42px; 
            text-transform: uppercase; 
            letter-spacing: 4px;
            text-shadow: 0 0 30px rgba(251, 191, 36, 0.5);
            margin-bottom: 40px;
        }

        .btn {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            border: 2px solid #fbbf24;
            color: white;
            padding: 16px 50px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 12px;
            cursor: pointer;
            margin: 12px;
            transition: transform 0.1s, box-shadow 0.1s;
            text-transform: uppercase;
        }
        .btn:active { transform: scale(0.95); box-shadow: 0 0 20px rgba(37, 99, 235, 0.4); }

        #debug-toggle-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            background: rgba(255,255,255,0.1);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 30px;
            z-index: 10001;
            cursor: pointer;
        }

        /* –ò–ì–†–û–í–û–ô –ò–ù–¢–ï–†–§–ï–ô–° */
        #game-ui { display: none; pointer-events: none; }

        #minimap-container {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 140px;
            height: 140px;
            background: rgba(0, 15, 0, 0.8);
            border: 2px solid #334155;
            border-radius: 12px;
            overflow: hidden;
            pointer-events: auto;
        }
        #minimap-canvas { width: 100%; height: 100%; }

        #joy-base {
            position: absolute;
            bottom: 50px;
            left: 50px;
            width: 120px;
            height: 120px;
            background: rgba(255, 255, 255, 0.03);
            border: 3px solid rgba(255, 255, 255, 0.15);
            border-radius: 60px;
            pointer-events: auto;
        }
        #joy-stick {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 50px;
            height: 50px;
            background: radial-gradient(circle, #fff, #94a3b8);
            border-radius: 25px;
            transform: translate(-50%, -50%);
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }

        /* –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –ö–ù–û–ü–ö–ê –í–û–ó–í–†–ê–¢–ê */
        #recall-btn {
            position: absolute;
            bottom: 60px;
            right: 60px;
            width: 75px;
            height: 75px;
            background: linear-gradient(135deg, #4338ca, #312e81);
            border: 3px solid #e0e7ff;
            border-radius: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            color: white;
            pointer-events: auto;
            cursor: pointer;
            box-shadow: 0 0 25px rgba(67, 56, 202, 0.5);
            transition: all 0.1s;
            z-index: 500;
        }
        #recall-btn:active { transform: scale(0.85); box-shadow: 0 0 10px rgba(67, 56, 202, 0.8); }

        #recall-msg {
            position: absolute;
            bottom: 180px;
            width: 100%;
            text-align: center;
            color: #22d3ee;
            font-size: 26px;
            font-weight: bold;
            display: none;
            text-shadow: 0 0 15px #000;
            letter-spacing: 2px;
        }

        .s-row { width: 320px; display: flex; justify-content: space-between; align-items: center; margin: 20px 0; font-size: 18px; }
        input[type=range] { width: 150px; }
    </style>
</head>
<body>

    <div id="debug-log"></div>
    <div id="debug-toggle-btn" onclick="toggleDebug()">CONSOLE: OFF</div>

    <div id="menu-screen" class="screen">
        <h1>MOBA LEGENDS</h1>
        <button class="btn" onclick="startGame()">–í –ë–û–ô</button>
        <button class="btn" onclick="toggleSettings(true)">–ù–ê–°–¢–†–û–ô–ö–ò</button>
    </div>

    <div id="settings-screen" class="screen">
        <h2>–ù–ê–°–¢–†–û–ô–ö–ò –ò–ì–†–´</h2>
        <div class="s-row">
            <span>–ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</span>
            <input type="range" id="sens-input" min="0.5" max="4" step="0.1" value="1.8">
        </div>
        <button class="btn" onclick="toggleSettings(false)">–°–û–•–†–ê–ù–ò–¢–¨</button>
    </div>

    <div id="game-ui" class="screen">
        <div id="minimap-container">
            <canvas id="minimap-canvas"></canvas>
        </div>
        
        <div id="joy-base"><div id="joy-stick"></div></div>
        
        <div id="recall-msg">–í–û–ó–í–†–ê–©–ï–ù–ò–ï... <span id="recall-timer">5</span></div>
        <div id="recall-btn">üè†</div>
        
        <div id="cam-touch-area" style="position:absolute; right:0; top:0; width:65%; height:100%; pointer-events:auto;"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        // --- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ---
        let scene, camera, renderer, player, recallEffect;
        let obstacles = [];
        let isMoving = false, joyVec = { x: 0, z: 0 };
        let isRecalling = false, recallInterval;
        let camOffset = { x: 0, z: 0 };
        let config = { sensitivity: 1.8 };
        
        const debugLog = document.getElementById('debug-log');
        let debugActive = false;

        // --- –õ–û–ì–ò–†–û–í–ê–ù–ò–ï ---
        function log(msg, type = 'info') {
            const time = new Date().toLocaleTimeString().split(' ')[0];
            const entry = document.createElement('div');
            entry.style.color = type === 'err' ? '#ff4757' : (type === 'warn' ? '#ffa502' : '#2ed573');
            entry.innerText = `[${time}] ${msg}`;
            debugLog.appendChild(entry);
            debugLog.scrollTop = debugLog.scrollHeight;
            console.log(`[GAME]: ${msg}`);
        }

        function toggleDebug() {
            debugActive = !debugActive;
            debugLog.style.display = debugActive ? 'block' : 'none';
            document.getElementById('debug-toggle-btn').innerText = `CONSOLE: ${debugActive ? 'ON' : 'OFF'}`;
            log(debugActive ? "–ö–æ–Ω—Å–æ–ª—å –≤–∫–ª—é—á–µ–Ω–∞" : "–ö–æ–Ω—Å–æ–ª—å –≤—ã–∫–ª—é—á–µ–Ω–∞");
        }

        function toggleSettings(show) {
            document.getElementById('settings-screen').style.display = show ? 'flex' : 'none';
        }

        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ò–ì–†–´ ---
        function startGame() {
            log("–ó–∞–ø—É—Å–∫ –∏–≥—Ä–æ–≤–æ–≥–æ –¥–≤–∏–∂–∫–∞...");
            config.sensitivity = parseFloat(document.getElementById('sens-input').value);
            document.getElementById('menu-screen').style.display = 'none';
            document.getElementById('game-ui').style.display = 'block';
            initThree();
        }

        function initThree() {
            try {
                scene = new THREE.Scene();
                scene.background = new THREE.Color(0x020617);
                scene.fog = new THREE.Fog(0x020617, 20, 150);

                camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
                
                renderer = new THREE.WebGLRenderer({ antialias: true });
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.setPixelRatio(window.devicePixelRatio);
                document.body.appendChild(renderer.domElement);

                const ambient = new THREE.AmbientLight(0xffffff, 0.5);
                scene.add(ambient);
                const sun = new THREE.DirectionalLight(0xffffff, 1.2);
                sun.position.set(50, 100, 50);
                scene.add(sun);

                buildWorld();
                spawnPlayer();
                initControls();
                
                log("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!");
                animate();
            } catch (e) {
                log("–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: " + e.message, 'err');
            }
        }

        function buildWorld() {
            // –ü–æ–ª
            const ground = new THREE.Mesh(
                new THREE.PlaneGeometry(500, 500), 
                new THREE.MeshStandardMaterial({ color: 0x14532d })
            );
            ground.rotation.x = -Math.PI / 2;
            scene.add(ground);

            // –†–µ–∫–∞ (MLBB Style - 90 –≥—Ä–∞–¥—É—Å–æ–≤)
            const river = new THREE.Mesh(
                new THREE.PlaneGeometry(50, 500),
                new THREE.MeshStandardMaterial({ color: 0x0369a1, transparent: true, opacity: 0.7 })
            );
            river.rotation.x = -Math.PI / 2;
            river.position.y = 0.1;
            scene.add(river);

            // –ë–∞—à–Ω–∏ –Ω–∞ –ú–∏–¥—É
            for(let i = 1; i <= 3; i++) {
                addTower(-40 - (i*35), 40 + (i*35), 0x2563eb); // –°–∏–Ω–∏–µ
                addTower(40 + (i*35), -40 - (i*35), 0xdc2626); // –ö—Ä–∞—Å–Ω—ã–µ
            }

            // –ë–∞–∑—ã
            addFortress(-180, 180, 0x1d4ed8);
            addFortress(180, -180, 0xb91c1c);
            
            log("–ú–∏—Ä –ø–æ—Å—Ç—Ä–æ–µ–Ω: –†–µ–∫–∞, –ë–∞–∑—ã, 6 –ë–∞—à–µ–Ω");
        }

        function addTower(x, z, color) {
            const g = new THREE.Group();
            const body = new THREE.Mesh(new THREE.CylinderGeometry(2, 3, 12, 8), new THREE.MeshStandardMaterial({color: 0x334155}));
            const head = new THREE.Mesh(new THREE.SphereGeometry(2), new THREE.MeshStandardMaterial({color: color, emissive: color}));
            head.position.y = 7;
            g.add(body); g.add(head);
            g.position.set(x, 6, z);
            scene.add(g);
            obstacles.push({ x, z, r: 4, color });
        }

        function addFortress(x, z, color) {
            const b = new THREE.Mesh(new THREE.BoxGeometry(12, 18, 12), new THREE.MeshStandardMaterial({color: 0x1e293b}));
            const crystal = new THREE.Mesh(new THREE.OctahedronGeometry(5), new THREE.MeshStandardMaterial({color: color, emissive: color}));
            crystal.position.y = 12;
            b.add(crystal);
            b.position.set(x, 9, z);
            scene.add(b);
            obstacles.push({ x, z, r: 10, color });
        }

        function spawnPlayer() {
            player = new THREE.Group();
            
            // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –≥–µ–æ–º–µ—Ç—Ä–∏–∏
            let bodyGeo;
            if (typeof THREE.CapsuleGeometry !== 'undefined') {
                bodyGeo = new THREE.CapsuleGeometry(0.7, 1.2, 4, 8);
            } else {
                log("CapsuleGeometry –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É—é Cylinder", 'warn');
                bodyGeo = new THREE.CylinderGeometry(0.7, 0.7, 2.4, 12);
            }

            const body = new THREE.Mesh(bodyGeo, new THREE.MeshStandardMaterial({ color: 0x0ea5e9 }));
            body.position.y = 1.2;
            player.add(body);

            // –ú–µ—á
            const sword = new THREE.Mesh(new THREE.BoxGeometry(0.2, 3, 0.2), new THREE.MeshStandardMaterial({ color: 0xf8fafc }));
            sword.position.set(0.9, 1.5, 0.6);
            sword.rotation.x = 0.4;
            player.add(sword);

            // –≠—Ñ—Ñ–µ–∫—Ç –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏—è
            recallEffect = new THREE.Mesh(
                new THREE.CylinderGeometry(3, 3, 40, 16, 1, true),
                new THREE.MeshBasicMaterial({ color: 0x22d3ee, transparent: true, opacity: 0, side: THREE.DoubleSide })
            );
            recallEffect.position.y = 20;
            player.add(recallEffect);

            scene.add(player);
            player.position.set(-165, 0, 165);
            log("–ì–µ—Ä–æ–π –∑–∞—Å–ø–∞–≤–Ω–µ–Ω –Ω–∞ –±–∞–∑–µ");
        }

        // --- –£–ü–†–ê–í–õ–ï–ù–ò–ï ---
        function initControls() {
            const jBase = document.getElementById('joy-base'), jStick = document.getElementById('joy-stick');
            
            const handleJoy = (e) => {
                e.preventDefault();
                const t = e.touches ? e.touches[0] : e;
                const rect = jBase.getBoundingClientRect();
                const dx = t.clientX - (rect.left + 60), dy = t.clientY - (rect.top + 60);
                const dist = Math.min(Math.sqrt(dx*dx + dy*dy), 50);
                const angle = Math.atan2(dy, dx);
                
                jStick.style.transform = `translate(calc(-50% + ${Math.cos(angle)*dist}px), calc(-50% + ${Math.sin(angle)*dist}px))`;
                joyVec = { x: Math.cos(angle), z: Math.sin(angle) };
                isMoving = true;
                if(isRecalling) cancelRecall();
            };

            jBase.addEventListener('touchstart', handleJoy);
            jBase.addEventListener('touchmove', handleJoy);
            window.addEventListener('touchend', () => {
                isMoving = false;
                jStick.style.transform = 'translate(-50%, -50%)';
            });

            // –ö–∞–º–µ—Ä–∞
            const camArea = document.getElementById('cam-touch-area');
            let lastX, lastY;
            camArea.addEventListener('touchstart', e => {
                lastX = e.touches[0].clientX;
                lastY = e.touches[0].clientY;
            });
            camArea.addEventListener('touchmove', e => {
                const dx = e.touches[0].clientX - lastX;
                const dy = e.touches[0].clientY - lastY;
                camOffset.x += dx * 0.05 * config.sensitivity;
                camOffset.z += dy * 0.05 * config.sensitivity;
                lastX = e.touches[0].clientX;
                lastY = e.touches[0].clientY;
            });

            // –ö–ù–û–ü–ö–ê –í–û–ó–í–†–ê–¢–ê (–ò–°–ü–†–ê–í–õ–ï–ù–û)
            const rBtn = document.getElementById('recall-btn');
            const recallTrigger = (e) => {
                e.preventDefault();
                log("–ö–Ω–æ–ø–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –Ω–∞–∂–∞—Ç–∞");
                if (!isRecalling && !isMoving) {
                    startRecall();
                } else if (isMoving) {
                    log("–í–æ–∑–≤—Ä–∞—Ç –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω: –≥–µ—Ä–æ–π –≤ –¥–≤–∏–∂–µ–Ω–∏–∏", 'warn');
                }
            };
            rBtn.addEventListener('touchstart', recallTrigger);
            rBtn.addEventListener('mousedown', recallTrigger);
        }

        // --- –õ–û–ì–ò–ö–ê –í–û–ó–í–†–ê–©–ï–ù–ò–Ø ---
        function startRecall() {
            log("–ù–∞—á–∞–ª–æ —Ç–µ–ª–µ–ø–æ—Ä—Ç–∞—Ü–∏–∏...");
            isRecalling = true;
            document.getElementById('recall-msg').style.display = 'block';
            recallEffect.material.opacity = 0.5;
            
            let timeLeft = 5;
            document.getElementById('recall-timer').innerText = timeLeft;
            
            recallInterval = setInterval(() => {
                timeLeft--;
                document.getElementById('recall-timer').innerText = timeLeft;
                log(`–¢–µ–ª–µ–ø–æ—Ä—Ç–∞—Ü–∏—è: ${timeLeft}—Å–µ–∫...`);
                
                if (timeLeft <= 0) {
                    player.position.set(-165, 0, 165);
                    log("–ì–µ—Ä–æ–π –≤–µ—Ä–Ω—É–ª—Å—è –Ω–∞ –±–∞–∑—É!");
                    cancelRecall();
                }
            }, 1000);
        }

        function cancelRecall() {
            if(!isRecalling) return;
            log("–í–æ–∑–≤—Ä–∞—Ç –ø—Ä–µ—Ä–≤–∞–Ω");
            isRecalling = false;
            clearInterval(recallInterval);
            document.getElementById('recall-msg').style.display = 'none';
            recallEffect.material.opacity = 0;
        }

        // --- –ú–ò–ù–ò–ö–ê–†–¢–ê ---
        function updateMinimap() {
            const canvas = document.getElementById('minimap-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 140; canvas.height = 140;

            ctx.fillStyle = 'rgba(0, 20, 0, 0.5)';
            ctx.fillRect(0, 0, 140, 140);

            // –ë–∞—à–Ω–∏
            obstacles.forEach(o => {
                ctx.fillStyle = o.color === 0x2563eb ? '#2563eb' : '#dc2626';
                const mx = ((o.x + 250) / 500) * 140;
                const mz = ((o.z + 250) / 500) * 140;
                ctx.fillRect(mx-3, mz-3, 6, 6);
            });

            // –ò–≥—Ä–æ–∫
            ctx.fillStyle = '#ffffff';
            const px = ((player.position.x + 250) / 500) * 140;
            const pz = ((player.position.z + 250) / 500) * 140;
            ctx.beginPath();
            ctx.arc(px, pz, 4, 0, Math.PI*2);
            ctx.fill();
        }

        // --- –¶–ò–ö–õ –†–ï–ù–î–ï–†–ê ---
        function animate() {
            requestAnimationFrame(animate);
            
            if (isMoving && !isRecalling) {
                const speed = 0.2;
                const nextX = player.position.x + joyVec.x * speed;
                const nextZ = player.position.z + joyVec.z * speed;
                
                let collision = false;
                obstacles.forEach(o => {
                    const dist = Math.sqrt((nextX - o.x)**2 + (nextZ - o.z)**2);
                    if (dist < o.r + 1) collision = true;
                });

                if (!collision && Math.abs(nextX) < 240 && Math.abs(nextZ) < 240) {
                    player.position.set(nextX, 0, nextZ);
                }
                player.rotation.y = Math.atan2(-joyVec.x, -joyVec.z);
            }

            if (isRecalling) {
                recallEffect.rotation.y += 0.15;
            }

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã
            camOffset.x *= 0.9; camOffset.z *= 0.9;
            camera.position.set(player.position.x + camOffset.x, 26, player.position.z + 22 + camOffset.z);
            camera.lookAt(player.position.x + camOffset.x, 0, player.position.z + camOffset.z);

            updateMinimap();
            renderer.render(scene, camera);
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

    </script>
</body>
</html>
