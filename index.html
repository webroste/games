<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MLBB: Stable Edition</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; touch-action: none; font-family: sans-serif; user-select: none; }
        .screen { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10; }
        
        /* –ö–û–ù–°–û–õ–¨ */
        #debug-log {
            position: absolute; top: 10px; left: 10px; width: 220px; max-height: 100px;
            background: rgba(0,0,0,0.8); color: #0f0; font-family: monospace; font-size: 10px;
            padding: 8px; border-radius: 5px; overflow-y: auto; z-index: 1000;
            display: none; pointer-events: none; border: 1px solid #333;
        }

        /* –ú–ï–ù–Æ */
        #menu-screen { background: radial-gradient(circle, #1a2a6c, #000); }
        h1 { color: #f1c40f; font-size: 32px; text-shadow: 0 0 15px #f1c40f; }
        
        #debug-toggle { position: absolute; top: 15px; right: 15px; background: rgba(255,255,255,0.1); color: #fff; border: 1px solid #fff; padding: 8px 12px; border-radius: 5px; cursor: pointer; z-index: 1100; pointer-events: auto; }

        /* –ù–ê–°–¢–†–û–ô–ö–ò */
        #settings-screen { background: #111; display: none; color: white; z-index: 600; }
        .s-row { width: 280px; display: flex; justify-content: space-between; margin: 15px 0; }

        .btn {
            background: #2980b9; border: 2px solid #f1c40f; color: white;
            padding: 12px 35px; font-size: 16px; font-weight: bold; border-radius: 8px; cursor: pointer; margin: 10px;
        }

        /* –ò–ì–†–û–í–û–ô –ò–ù–¢–ï–†–§–ï–ô–° */
        #game-ui { display: none; pointer-events: none; }
        #minimap { position: absolute; top: 10px; left: 10px; width: 110px; height: 110px; background: rgba(0,20,0,0.8); border: 2px solid #444; border-radius: 5px; }
        
        #joy-base { position: absolute; bottom: 40px; left: 40px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; pointer-events: auto; }
        #joy-stick { position: absolute; top: 50%; left: 50%; width: 40px; height: 40px; background: #fff; border-radius: 50%; transform: translate(-50%, -50%); opacity: 0.8; }
        
        /* –£–ú–ï–ù–¨–®–ï–ù–ù–ê–Ø –ö–ù–û–ü–ö–ê –í–û–ó–í–†–ê–¢–ê */
        #recall-btn { 
            position: absolute; bottom: 40px; right: 40px; width: 65px; height: 65px; 
            border-radius: 50%; background: #4834d4; border: 3px solid #fff; 
            color: white; display: flex; align-items: center; justify-content: center; 
            font-size: 28px; pointer-events: auto; cursor: pointer;
            box-shadow: 0 0 15px #4834d4; transition: transform 0.1s;
        }
        #recall-btn:active { transform: scale(0.8); background: #3c2bb3; }

        #msg { position: absolute; bottom: 150px; width: 100%; text-align: center; color: #00ffff; font-size: 20px; font-weight: bold; display: none; }
    </style>
</head>
<body>

    <div id="debug-log"></div>
    <div id="debug-toggle" onclick="toggleDebug()">DEBUG</div>

    <div id="menu-screen" class="screen">
        <h1>MOBA LEGENDS</h1>
        <button class="btn" onclick="startGame()">–í –ë–û–ô</button>
        <button class="btn" onclick="showSettings(true)">–ù–ê–°–¢–†–û–ô–ö–ò</button>
    </div>

    <div id="settings-screen" class="screen">
        <h2>–ù–ê–°–¢–†–û–ô–ö–ò</h2>
        <div class="s-row"><span>–ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</span><input type="range" id="sens" min="0.5" max="3" step="0.1" value="1.5"></div>
        <button class="btn" onclick="showSettings(false)">–°–û–•–†–ê–ù–ò–¢–¨</button>
    </div>

    <div id="game-ui" class="screen">
        <div id="minimap"></div>
        <div id="joy-base"><div id="joy-stick"></div></div>
        <div id="msg">–í–û–ó–í–†–ê–©–ï–ù–ò–ï... <span id="timer">5</span></div>
        <div id="recall-btn">üè†</div>
        <div id="cam-zone" style="position:absolute; right:0; top:0; width:60%; height:100%; pointer-events:auto;"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        const logEl = document.getElementById('debug-log');
        let dbg = false;
        function log(m) { if(dbg) { const d=document.createElement('div'); d.innerText="> "+m; logEl.appendChild(d); logEl.scrollTop=logEl.scrollHeight; } }
        function toggleDebug() { dbg=!dbg; logEl.style.display=dbg?'block':'none'; }

        let scene, camera, renderer, player, recallFx, obstacles = [];
        let moveDir = { x: 0, z: 0 }, isMoving = false;
        let isRecalling = false, recallCounter;
        let camRot = { x: 0, z: 0 };
        let sens = 1.5;

        function showSettings(s) { document.getElementById('settings-screen').style.display = s?'flex':'none'; }

        function startGame() {
            sens = parseFloat(document.getElementById('sens').value);
            document.getElementById('menu-screen').style.display = 'none';
            document.getElementById('game-ui').style.display = 'block';
            init();
        }

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x050a05);
            camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.1, 1000);
            
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            scene.add(new THREE.AmbientLight(0xffffff, 0.5));
            const light = new THREE.DirectionalLight(0xffffff, 1);
            light.position.set(10, 20, 10);
            scene.add(light);

            buildMap();
            createPlayer();
            setupInputs();
            animate();
        }

        function buildMap() {
            // –ó–µ–º–ª—è
            const ground = new THREE.Mesh(new THREE.PlaneGeometry(400, 400), new THREE.MeshStandardMaterial({color: 0x1a261a}));
            ground.rotation.x = -Math.PI/2;
            scene.add(ground);

            // –†–µ–∫–∞ (–≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è)
            const river = new THREE.Mesh(new THREE.PlaneGeometry(40, 400), new THREE.MeshStandardMaterial({color: 0x004d99, transparent: true, opacity: 0.6}));
            river.rotation.x = -Math.PI/2;
            river.position.y = 0.05;
            scene.add(river);

            // –ë–∞—à–Ω–∏ –Ω–∞ –ú–ò–î–£ (3 —Å–∏–Ω–∏—Ö, 3 –∫—Ä–∞—Å–Ω—ã—Ö)
            for(let i=1; i<=3; i++) {
                createTower(-40 - (i*30), 40 + (i*30), 0x00a2ff); // –°–∏–Ω–∏–µ
                createTower(40 + (i*30), -40 - (i*30), 0xff3300); // –ö—Ä–∞—Å–Ω—ã–µ
            }

            // –ì–ª–∞–≤–Ω—ã–µ –±–∞–∑—ã
            createBase(-170, 170, 0x00a2ff);
            createBase(170, -170, 0xff3300);
        }

        function createTower(x, z, col) {
            const g = new THREE.Group();
            const b = new THREE.Mesh(new THREE.CylinderGeometry(2, 2.5, 8, 8), new THREE.MeshStandardMaterial({color: 0x444}));
            const h = new THREE.Mesh(new THREE.SphereGeometry(1.5), new THREE.MeshStandardMaterial({color: col}));
            h.position.y = 5; g.add(b); g.add(h); g.position.set(x, 4, z);
            scene.add(g); obstacles.push({x, z, r: 3});
        }

        function createBase(x, z, col) {
            const b = new THREE.Mesh(new THREE.BoxGeometry(10, 15, 10), new THREE.MeshStandardMaterial({color: 0x222}));
            const c = new THREE.Mesh(new THREE.OctahedronGeometry(4), new THREE.MeshStandardMaterial({color: col}));
            c.position.y = 10; b.add(c); b.position.set(x, 7.5, z);
            scene.add(b); obstacles.push({x, z, r: 8});
        }

        function createPlayer() {
            player = new THREE.Group();
            const b = new THREE.Mesh(new THREE.CylinderGeometry(0.6, 0.6, 2, 8), new THREE.MeshStandardMaterial({color: 0x00d2ff}));
            b.position.y = 1; player.add(b);
            
            // –ú–µ—á
            const s = new THREE.Mesh(new THREE.BoxGeometry(0.2, 2.5, 0.2), new THREE.MeshStandardMaterial({color: 0xffffff}));
            s.position.set(0.7, 1.2, 0.4); s.rotation.x = 0.5; player.add(s);

            // –†–µ–∫–æ–ª–ª FX
            recallFx = new THREE.Mesh(new THREE.CylinderGeometry(2, 2, 20, 16, 1, true), new THREE.MeshBasicMaterial({color: 0x00ffff, transparent: true, opacity: 0, side: THREE.DoubleSide}));
            recallFx.position.y = 10; player.add(recallFx);

            scene.add(player);
            player.position.set(-160, 0, 160);
        }

        function setupInputs() {
            const jb = document.getElementById('joy-base'), js = document.getElementById('joy-stick');
            
            const handleJoy = (e) => {
                e.preventDefault();
                const t = e.touches ? e.touches[0] : e;
                const r = jb.getBoundingClientRect();
                const dx = t.clientX - (r.left + 50), dy = t.clientY - (r.top + 50);
                const d = Math.min(Math.sqrt(dx*dx+dy*dy), 40);
                const a = Math.atan2(dy, dx);
                js.style.transform = `translate(calc(-50% + ${Math.cos(a)*d}px), calc(-50% + ${Math.sin(a)*d}px))`;
                moveDir = { x: Math.cos(a), z: Math.sin(a) };
                isMoving = true; if(isRecalling) cancelRecall();
            };

            jb.addEventListener('touchstart', handleJoy); jb.addEventListener('touchmove', handleJoy);
            window.addEventListener('touchend', () => { isMoving = false; js.style.transform='translate(-50%,-50%)'; });

            // –ü–û–í–û–†–û–¢ –ö–ê–ú–ï–†–´
            const cz = document.getElementById('cam-zone');
            let lX, lY;
            cz.addEventListener('touchstart', e => { lX = e.touches[0].clientX; lY = e.touches[0].clientY; });
            cz.addEventListener('touchmove', e => {
                camRot.x += (e.touches[0].clientX - lX) * 0.05 * sens;
                camRot.z += (e.touches[0].clientY - lY) * 0.05 * sens;
                lX = e.touches[0].clientX; lY = e.touches[0].clientY;
            });

            // –ö–ù–û–ü–ö–ê –í–û–ó–í–†–ê–¢–ê (–ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê)
            const rb = document.getElementById('recall-btn');
            rb.addEventListener('pointerdown', (e) => {
                e.stopPropagation();
                if(!isRecalling && !isMoving) startRecall();
            });
        }

        function startRecall() {
            isRecalling = true;
            document.getElementById('msg').style.display = 'block';
            recallFx.material.opacity = 0.4;
            let time = 5; document.getElementById('timer').innerText = time;
            recallCounter = setInterval(() => {
                time--; document.getElementById('timer').innerText = time;
                if(time <= 0) { player.position.set(-160, 0, 160); cancelRecall(); }
            }, 1000);
        }

        function cancelRecall() {
            isRecalling = false; clearInterval(recallCounter);
            document.getElementById('msg').style.display = 'none';
            recallFx.material.opacity = 0;
        }

        function animate() {
            requestAnimationFrame(animate);
            if(isMoving && !isRecalling) {
                let nX = player.position.x + moveDir.x * 0.15;
                let nZ = player.position.z + moveDir.z * 0.15;
                let hit = false;
                obstacles.forEach(o => { if(Math.sqrt((nX-o.x)**2 + (nZ-o.z)**2) < o.r + 0.8) hit = true; });
                if(!hit) player.position.set(nX, 0, nZ);
                player.rotation.y = Math.atan2(-moveDir.x, -moveDir.z);
            }

            camRot.x *= 0.9; camRot.z *= 0.9;
            camera.position.set(player.position.x + camRot.x, 22, player.position.z + 18 + camRot.z);
            camera.lookAt(player.position.x + camRot.x, 0, player.position.z + camRot.z);
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
