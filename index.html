<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Chaos Arena: Battle Royale Edition</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Courier New', monospace; user-select: none; }
        #ui { position: fixed; inset: 0; pointer-events: none; z-index: 10; color: #0f0; display: none; padding: 20px; }
        #hp-bar { width: 300px; height: 25px; background: #300; border: 2px solid #0f0; position: relative; }
        #hp-fill { width: 100%; height: 100%; background: #0f0; transition: 0.2s; }
        #stats { position: absolute; top: 20px; right: 20px; text-align: right; font-size: 20px; text-shadow: 2px 2px #000; }
        #crosshair { position: fixed; top: 50%; left: 50%; width: 20px; height: 20px; border: 2px solid #0f0; border-radius: 50%; transform: translate(-50%, -50%); }
        #start-screen { position: fixed; inset: 0; background: #050505; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; color: #0f0; border: 5px solid #0f0; }
        button { background: #000; color: #0f0; border: 3px solid #0f0; padding: 20px 50px; font-size: 24px; cursor: pointer; font-weight: bold; }
        button:hover { background: #0f0; color: #000; }
        .log { position: absolute; bottom: 20px; left: 20px; color: #888; font-size: 12px; }
    </style>
</head>
<body>

<div id="start-screen">
    <h1 style="font-size: 60px;">CHAOS ARENA</h1>
    <p>20 БОЙЦОВ | СВОБОДНАЯ ОХОТА | ПОСТРОЙКИ</p>
    <button onclick="startGame()">ВЫСАДКА</button>
    <div style="margin-top: 20px;">WASD - Движение | SPACE - Огонь | Q/E - Навыки</div>
</div>

<div id="ui">
    <div id="crosshair"></div>
    <div id="hp-bar"><div id="hp-fill"></div><div style="position:absolute; top:0; width:100%; text-align:center; color:#000; font-weight:bold;">HEALTH</div></div>
    <div id="stats">
        KILLS: <span id="kills">0</span><br>
        ALIVE: <span id="alive">20</span>
    </div>
    <div class="log" id="game-log">Система инициализирована...</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
let scene, camera, renderer, player, clock;
let gameActive = false;
let entities = [];
let bullets = [];
let keys = {};
let score = 0;
const MAX_ENTITIES = 20;

function startGame() {
    document.getElementById('start-screen').style.display = 'none';
    document.getElementById('ui').style.display = 'block';
    init();
}

function init() {
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x020205);
    scene.fog = new THREE.Fog(0x020205, 50, 150);
    clock = new THREE.Clock();

    camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    // Освещение
    scene.add(new THREE.AmbientLight(0x404040, 1));
    const pointLight = new THREE.PointLight(0x00ff00, 1, 100);
    pointLight.position.set(0, 20, 0);
    scene.add(pointLight);

    // Земля (Сетка)
    const grid = new THREE.GridHelper(400, 40, 0x00ff00, 0x002200);
    scene.add(grid);

    // Постройки (Город)
    for (let i = 0; i < 30; i++) {
        const h = 5 + Math.random() * 15;
        const b = new THREE.Mesh(
            new THREE.BoxGeometry(4 + Math.random()*6, h, 4 + Math.random()*6),
            new THREE.MeshStandardMaterial({ color: 0x111111, emissive: 0x001100 })
        );
        b.position.set((Math.random()-0.5)*200, h/2, (Math.random()-0.5)*200);
        scene.add(b);
    }

    // Игрок
    player = createUnit(0x00aaff, true);
    player.mesh.position.set(0, 0, 0);
    entities.push(player);

    window.onkeydown = (e) => keys[e.code] = true;
    window.onkeyup = (e) => keys[e.code] = false;

    gameActive = true;
    animate();
}

function createUnit(color, isPlayer = false) {
    const group = new THREE.Group();
    
    // Тело
    const body = new THREE.Mesh(new THREE.BoxGeometry(1.2, 2.5, 1.2), new THREE.MeshStandardMaterial({ color }));
    body.position.y = 1.25;
    group.add(body);

    // Голова
    const head = new THREE.Mesh(new THREE.BoxGeometry(1, 1, 1), new THREE.MeshStandardMaterial({ color }));
    head.position.y = 3;
    group.add(head);

    // Оружие
    const gun = new THREE.Mesh(new THREE.BoxGeometry(0.3, 0.3, 1.5), new THREE.MeshStandardMaterial({ color: 0x222222 }));
    gun.position.set(0.7, 2.2, 0.8);
    group.add(gun);

    scene.add(group);
    return { mesh: group, hp: 100, isPlayer, lastShot: 0, target: null, isMoving: false };
}

function spawnBullet(owner) {
    const bGeo = new THREE.SphereGeometry(0.2);
    const bMat = new THREE.MeshBasicMaterial({ color: owner.isPlayer ? 0x00ffff : 0xff0000 });
    const bullet = new THREE.Mesh(bGeo, bMat);
    
    bullet.position.copy(owner.mesh.position);
    bullet.position.y = 2.2;
    
    const direction = new THREE.Vector3(0, 0, 1);
    direction.applyQuaternion(owner.mesh.quaternion);
    
    bullets.push({ mesh: bullet, dir: direction, owner });
    scene.add(bullet);
}

function animate() {
    if (!gameActive) return;
    requestAnimationFrame(animate);
    const delta = clock.getDelta();
    const time = clock.getElapsedTime();

    // Спавн ботов
    if (entities.length < MAX_ENTITIES) {
        const bot = createUnit(0xff3333);
        bot.mesh.position.set((Math.random()-0.5)*180, 0, (Math.random()-0.5)*180);
        entities.push(bot);
    }

    // Логика существ
    entities.forEach((ent, idx) => {
        if (ent.isPlayer) {
            handleInput();
        } else {
            // ИИ: ищет ближайшего врага
            let closest = null;
            let dMin = 40;
            entities.forEach(other => {
                if (other === ent) return;
                let d = ent.mesh.position.distanceTo(other.mesh.position);
                if (d < dMin) { dMin = d; closest = other; }
            });

            if (closest) {
                ent.mesh.lookAt(closest.mesh.position);
                if (dMin > 12) {
                    ent.mesh.translateZ(0.12);
                    ent.isMoving = true;
                } else {
                    ent.isMoving = false;
                    if (Date.now() - ent.lastShot > 800) {
                        spawnBullet(ent);
                        ent.lastShot = Date.now();
                    }
                }
            } else {
                ent.isMoving = false;
                ent.mesh.rotation.y += 0.01;
            }
        }

        // Анимации
        const body = ent.mesh.children[0];
        if (ent.isMoving) {
            body.rotation.z = Math.sin(time * 12) * 0.1;
            body.position.y = 1.25 + Math.abs(Math.sin(time * 12)) * 0.2;
        } else {
            body.rotation.z = 0;
            body.position.y = 1.25 + Math.sin(time * 2) * 0.05;
        }
    });

    // Пули
    for (let i = bullets.length - 1; i >= 0; i--) {
        const b = bullets[i];
        b.mesh.position.add(b.dir.clone().multiplyScalar(1.5));

        // Коллизии
        entities.forEach((ent, eIdx) => {
            if (ent === b.owner) return;
            if (b.mesh.position.distanceTo(ent.mesh.position) < 2) {
                ent.hp -= 25;
                scene.remove(b.mesh);
                bullets.splice(i, 1);
                
                if (ent.hp <= 0) {
                    if (ent.isPlayer) { alert("DEAD. Kills: " + score); location.reload(); }
                    if (b.owner.isPlayer) score++;
                    scene.remove(ent.mesh);
                    entities.splice(eIdx, 1);
                    document.getElementById('kills').innerText = score;
                }
            }
        });

        if (b.mesh.position.length() > 200) {
            scene.remove(b.mesh);
            bullets.splice(i, 1);
        }
    }

    document.getElementById('hp-fill').style.width = player.hp + "%";
    document.getElementById('alive').innerText = entities.length;

    camera.position.lerp(new THREE.Vector3(player.mesh.position.x, 35, player.mesh.position.z + 25), 0.1);
    camera.lookAt(player.mesh.position);
    renderer.render(scene, camera);
}

function handleInput() {
    player.isMoving = false;
    if (keys['KeyW']) { player.mesh.position.z -= 0.5; player.isMoving = true; }
    if (keys['KeyS']) { player.mesh.position.z += 0.5; player.isMoving = true; }
    if (keys['KeyA']) { player.mesh.position.x -= 0.5; player.isMoving = true; }
    if (keys['KeyD']) { player.mesh.position.x += 0.5; player.isMoving = true; }
    
    if (keys['KeyW'] || keys['KeyS'] || keys['KeyA'] || keys['KeyD']) {
        const dx = (keys['KeyD']?1:0) - (keys['KeyA']?1:0);
        const dz = (keys['KeyS']?1:0) - (keys['KeyW']?1:0);
        if (dx!==0 || dz!==0) player.mesh.rotation.y = Math.atan2(dx, dz);
    }

    if (keys['Space'] && Date.now() - player.lastShot > 250) {
        spawnBullet(player);
        player.lastShot = Date.now();
    }
}
</script>
</body>
</html>
