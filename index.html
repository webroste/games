<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MLBB: Master Edition</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; touch-action: none; font-family: 'Segoe UI', sans-serif; user-select: none; }
        .screen { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10; }
        
        /* DEBUG CONSOLE */
        #debug-log {
            position: absolute; top: 10px; left: 10px; width: 220px; max-height: 150px;
            background: rgba(0,0,0,0.85); color: #0f0; font-family: monospace; font-size: 11px;
            padding: 8px; border-radius: 6px; overflow-y: auto; z-index: 1000;
            display: none; pointer-events: none; border: 1px solid #00ff0033;
        }

        /* –ú–ï–ù–Æ */
        #menu-screen { background: radial-gradient(circle at center, #1a2a6c, #b21f1f, #fdbb2d); }
        h1 { color: #fff; font-size: 40px; text-shadow: 0 5px 15px rgba(0,0,0,0.5); margin-bottom: 30px; }
        
        #debug-toggle-btn {
            position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.5);
            color: #aaa; border: 1px solid #555; padding: 8px 15px; border-radius: 20px; cursor: pointer;
        }

        /* –ó–ê–ì–†–£–ó–ö–ê */
        #loading-screen { background: #000; display: none; z-index: 100; }
        .loader-text { color: white; margin-bottom: 15px; letter-spacing: 2px; }
        .bar { width: 250px; height: 4px; background: #333; border-radius: 2px; }
        .fill { width: 0%; height: 100%; background: #00d2ff; transition: width 0.1s; }

        /* –ò–ì–†–û–í–û–ô UI */
        #game-ui { display: none; pointer-events: none; }
        #minimap { position: absolute; top: 15px; left: 15px; width: 120px; height: 120px; background: rgba(0,10,0,0.9); border: 2px solid #555; border-radius: 8px; }
        
        #joy-base { position: absolute; bottom: 40px; left: 40px; width: 110px; height: 110px; background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.2); border-radius: 50%; pointer-events: auto; }
        #joy-stick { position: absolute; top: 50%; left: 50%; width: 45px; height: 45px; background: radial-gradient(#fff, #ccc); border-radius: 50%; transform: translate(-50%, -50%); box-shadow: 0 0 15px rgba(0,0,0,0.5); }
        
        #recall-btn { 
            position: absolute; bottom: 40px; right: 40px; width: 80px; height: 80px; 
            border-radius: 50%; background: linear-gradient(135deg, #4834d4, #686de0); 
            border: 4px solid #fff; color: white; display: flex; align-items: center; justify-content: center; 
            font-size: 35px; pointer-events: auto; cursor: pointer;
            transition: transform 0.1s, box-shadow 0.3s;
            box-shadow: 0 0 20px rgba(72, 52, 212, 0.6);
        }
        #recall-btn:active { transform: scale(0.85); box-shadow: 0 0 40px #00d2ff; }

        .btn-main {
            background: rgba(255,255,255,0.1); border: 2px solid #fff; color: white;
            padding: 15px 40px; font-size: 18px; border-radius: 30px; cursor: pointer; margin: 10px;
            backdrop-filter: blur(5px); transition: 0.3s;
        }
        .btn-main:hover { background: #fff; color: #000; }

        #msg { position: absolute; bottom: 160px; width: 100%; text-align: center; color: #00d2ff; font-weight: bold; font-size: 22px; display: none; text-shadow: 0 0 10px #000; }
    </style>
</head>
<body>

    <div id="debug-log"></div>

    <div id="menu-screen" class="screen">
        <div id="debug-toggle-btn" onclick="toggleDebug()">Debug: OFF</div>
        <h1>MOBA LEGENDS</h1>
        <button class="btn-main" onclick="showLoading()">–í –ë–û–ô</button>
    </div>

    <div id="loading-screen" class="screen">
        <div class="loader-text">–ì–ï–ù–ï–†–ê–¶–ò–Ø –õ–ê–ù–î–®–ê–§–¢–ê...</div>
        <div class="bar"><div id="fill" class="fill"></div></div>
    </div>

    <div id="game-ui" class="screen">
        <div id="minimap"></div>
        <div id="joy-base"><div id="joy-stick"></div></div>
        <div id="msg">–í–û–ó–í–†–ê–©–ï–ù–ò–ï... <span id="timer">5</span></div>
        <div id="recall-btn" ontouchstart="startRecall(event)" onmousedown="startRecall(event)">üè†</div>
        <div id="cam-zone" style="position:absolute; right:0; top:0; width:60%; height:100%; pointer-events:auto;"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        const debugLog = document.getElementById('debug-log');
        let debugEnabled = false;

        function log(m, err=false) {
            if(!debugEnabled) return;
            const e = document.createElement('div');
            e.style.color = err ? '#ff4b2b' : '#00d2ff';
            e.innerText = `> ${m}`;
            debugLog.appendChild(e);
            debugLog.scrollTop = debugLog.scrollHeight;
        }

        function toggleDebug() {
            debugEnabled = !debugEnabled;
            debugLog.style.display = debugEnabled ? 'block' : 'none';
            document.getElementById('debug-toggle-btn').innerText = `Debug: ${debugEnabled ? 'ON' : 'OFF'}`;
            log("–ö–æ–Ω—Å–æ–ª—å –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞");
        }

        window.onerror = (m, u, l) => log(`–û—à–∏–±–∫–∞: ${m} [—Å—Ç—Ä. ${l}]`, true);

        let scene, camera, renderer, player, recallPillar, obstacles = [];
        let isMoving = false, joyX = 0, joyZ = 0;
        let isRecalling = false, recallInterval;
        let camPan = { x: 0, z: 0 };
        const MAP_SIZE = 200; 

        function showLoading() {
            document.getElementById('menu-screen').style.display = 'none';
            document.getElementById('loading-screen').style.display = 'flex';
            let p = 0;
            let iv = setInterval(() => {
                p += 4; document.getElementById('fill').style.width = p + '%';
                if(p >= 100) { clearInterval(iv); init(); }
            }, 30);
        }

        function init() {
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('game-ui').style.display = 'block';

            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x020508);
            scene.fog = new THREE.Fog(0x020508, 30, 120);

            camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.body.appendChild(renderer.domElement);

            scene.add(new THREE.AmbientLight(0xffffff, 0.4));
            let sun = new THREE.DirectionalLight(0xffffff, 1.2);
            sun.position.set(50, 100, 50);
            scene.add(sun);

            generateMap();
            createHero();
            setupControls();
            log("–î–≤–∏–∂–æ–∫ –≥–æ—Ç–æ–≤. –ö–∞—Ä—Ç–∞: 200x200");
            animate();
        }

        function generateMap() {
            // –ó–µ–º–ª—è
            let ground = new THREE.Mesh(new THREE.PlaneGeometry(MAP_SIZE, MAP_SIZE), new THREE.MeshStandardMaterial({color: 0x151d15}));
            ground.rotation.x = -Math.PI/2;
            scene.add(ground);

            // –†–µ–∫–∞ (—Ç–µ–ø–µ—Ä—å —Å—Ç—Ä–æ–≥–æ –ø–æ —Ü–µ–Ω—Ç—Ä—É)
            let river = new THREE.Mesh(new THREE.PlaneGeometry(MAP_SIZE*1.5, 20), new THREE.MeshStandardMaterial({color: 0x003366, transparent: true, opacity: 0.8}));
            river.rotation.x = -Math.PI/2; river.rotation.z = Math.PI/4;
            river.position.y = 0.1;
            scene.add(river);

            // –°—Ç–µ–Ω—ã –∏ –¥–æ—Ä–æ–≥–∏
            for(let i=0; i<40; i++) {
                let x = (Math.random()-0.5)*MAP_SIZE;
                let z = (Math.random()-0.5)*MAP_SIZE;
                if(Math.abs(x+z) > 30) addRock(x, z);
            }

            // –¢–†–û–ù–´ (–£–±—Ä–∞–Ω—ã –≤ —É–≥–ª—ã)
            addMainStructure(-85, 85, 0x00a2ff); // –°–∏–Ω–∏–π —Ç—Ä–æ–Ω
            addMainStructure(85, -85, 0xff3300); // –ö—Ä–∞—Å–Ω—ã–π —Ç—Ä–æ–Ω

            // –ó–∞—â–∏—Ç–Ω—ã–µ –±–∞—à–Ω–∏ –Ω–∞ –ª–∏–Ω–∏—è—Ö
            addTower(-40, 40, 0x00a2ff);
            addTower(40, -40, 0xff3300);

            // –¢—Ä–∞–≤–∞
            for(let i=0; i<150; i++) {
                addGrass((Math.random()-0.5)*MAP_SIZE, (Math.random()-0.5)*MAP_SIZE);
            }
        }

        function addRock(x, z) {
            let h = 2 + Math.random()*4;
            let m = new THREE.Mesh(new THREE.BoxGeometry(4, h, 4), new THREE.MeshStandardMaterial({color: 0x3d3d3d}));
            m.position.set(x, h/2, z);
            scene.add(m);
            obstacles.push({x, z, r: 2.5});
        }

        function addMainStructure(x, z, col) {
            let g = new THREE.Group();
            let base = new THREE.Mesh(new THREE.CylinderGeometry(6, 7, 4, 6), new THREE.MeshStandardMaterial({color: 0x222}));
            g.add(base);
            let crystal = new THREE.Mesh(new THREE.OctahedronGeometry(3), new THREE.MeshStandardMaterial({color: col, emissive: col, emissiveIntensity: 2}));
            crystal.position.y = 6;
            g.add(crystal);
            g.position.set(x, 2, z);
            scene.add(g);
            obstacles.push({x, z, r: 7});
        }

        function addTower(x, z, col) {
            let t = new THREE.Mesh(new THREE.CylinderGeometry(2, 3, 10, 8), new THREE.MeshStandardMaterial({color: 0x444}));
            t.position.set(x, 5, z);
            let head = new THREE.Mesh(new THREE.SphereGeometry(1.5), new THREE.MeshStandardMaterial({color: col}));
            head.position.y = 6;
            t.add(head);
            scene.add(t);
            obstacles.push({x, z, r: 3});
        }

        function addGrass(x, z) {
            let colors = [0x2ecc71, 0x27ae60, 0x16a085];
            let g = new THREE.Mesh(new THREE.ConeGeometry(0.3, 1.5, 4), new THREE.MeshStandardMaterial({color: colors[Math.floor(Math.random()*3)]}));
            g.position.set(x, 0.75, z);
            scene.add(g);
        }

        function createHero() {
            player = new THREE.Group();
            
            // –¢–ï–õ–û
            let body = new THREE.Mesh(new THREE.CapsuleGeometry(0.6, 1.2, 4, 8), new THREE.MeshStandardMaterial({color: 0x00d2ff}));
            body.position.y = 1.2;
            player.add(body);

            // –ì–û–õ–û–í–ê/–®–õ–ï–ú
            let head = new THREE.Mesh(new THREE.SphereGeometry(0.4), new THREE.MeshStandardMaterial({color: 0xffffff}));
            head.position.y = 2.2;
            player.add(head);

            // –û–†–£–ñ–ò–ï (–°–≤–µ—Ç—è—â–∏–π—Å—è –º–µ—á)
            let sword = new THREE.Mesh(new THREE.BoxGeometry(0.2, 2.5, 0.2), new THREE.MeshStandardMaterial({color: 0xfff, emissive: 0x00d2ff}));
            sword.position.set(0.8, 1.5, 0.5);
            sword.rotation.x = 0.5;
            player.add(sword);

            // –≠—Ñ—Ñ–µ–∫—Ç —Ä–µ–∫–æ–ª–ª–∞ (—Å—Ç–æ–ª–± —Å–≤–µ—Ç–∞)
            let pGeo = new THREE.CylinderGeometry(1.5, 1.5, 20, 16, 1, true);
            let pMat = new THREE.MeshBasicMaterial({color: 0x00f2ff, transparent: true, opacity: 0, side: THREE.DoubleSide});
            recallPillar = new THREE.Mesh(pGeo, pMat);
            recallPillar.position.y = 10;
            player.add(recallPillar);

            scene.add(player);
            player.position.set(-80, 0, 80); // –°–ø–∞–≤–Ω —É —Å–∏–Ω–µ–≥–æ —Ç—Ä–æ–Ω–∞
        }

        function setupControls() {
            const jb = document.getElementById('joy-base'), js = document.getElementById('joy-stick');
            const handleMove = (e) => {
                e.preventDefault();
                const t = e.touches ? e.touches[0] : e;
                const r = jb.getBoundingClientRect();
                const dx = t.clientX - (r.left + 55), dy = t.clientY - (r.top + 55);
                const d = Math.min(Math.sqrt(dx*dx+dy*dy), 45);
                const a = Math.atan2(dy, dx);
                js.style.transform = `translate(calc(-50% + ${Math.cos(a)*d}px), calc(-50% + ${Math.sin(a)*d}px))`;
                joyX = Math.cos(a); joyZ = Math.sin(a); isMoving = true;
                if(isRecalling) stopRecall();
            };
            jb.addEventListener('touchstart', handleMove); jb.addEventListener('touchmove', handleMove);
            window.addEventListener('touchend', () => { isMoving = false; joyX=0; joyZ=0; js.style.transform='translate(-50%,-50%)'; });
        }

        window.startRecall = function(e) {
            if(e) e.stopPropagation();
            if(isRecalling || isMoving) return;
            log("–†–µ–∫–æ–ª–ª –∑–∞–ø—É—â–µ–Ω");
            isRecalling = true;
            document.getElementById('msg').style.display = 'block';
            
            let t = 5;
            document.getElementById('timer').innerText = t;
            recallPillar.material.opacity = 0.3;

            recallInterval = setInterval(() => {
                t--; document.getElementById('timer').innerText = t;
                if(t <= 0) {
                    player.position.set(-80, 0, 80);
                    stopRecall();
                    log("–ì–µ—Ä–æ–π –Ω–∞ –±–∞–∑–µ");
                }
            }, 1000);
        };

        function stopRecall() {
            isRecalling = false;
            clearInterval(recallInterval);
            document.getElementById('msg').style.display = 'none';
            recallPillar.material.opacity = 0;
        }

        function animate() {
            requestAnimationFrame(animate);
            
            if(isMoving && !isRecalling) {
                let speed = 0.14; // –ß—É—Ç—å –º–µ–Ω—å—à–µ —Å–∫–æ—Ä–æ—Å—Ç—å
                let nX = player.position.x + joyX * speed;
                let nZ = player.position.z + joyZ * speed;
                
                let hit = false;
                for(let o of obstacles) {
                    let d = Math.sqrt((nX-o.x)**2 + (nZ-o.z)**2);
                    if(d < o.r + 0.8) hit = true;
                }
                
                if(!hit && Math.abs(nX) < 98 && Math.abs(nZ) < 98) {
                    player.position.set(nX, 0, nZ);
                }
                player.rotation.y = Math.atan2(-joyX, -joyZ);
            }

            if(isRecalling) {
                recallPillar.rotation.y += 0.1;
                recallPillar.scale.x = recallPillar.scale.z = 1 + Math.sin(Date.now()*0.01)*0.1;
            }

            camPan.x *= 0.9; camPan.z *= 0.9;
            camera.position.set(player.position.x + camPan.x, 22, player.position.z + 18 + camPan.z);
            camera.lookAt(player.position.x + camPan.x, 0, player.position.z + camPan.z);

            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
